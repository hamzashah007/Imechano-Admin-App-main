<?php



namespace App\Http\Controllers\Api;



use App\Http\Controllers\Controller;

use Illuminate\Http\Request;

use Illuminate\Support\Facades\Hash;

use App\Models\User;

use App\Models\cars;

use App\Models\car_brands;

use App\Models\car_models;

use App\Models\service_categories;

use App\Models\service_subcategories;

use App\Models\items;

use App\Models\customer_bookings;

use Mail;

use App\Models\garages;

use App\Models\pickup_conditions;

use App\Models\job_cards;

use App\Models\Notifications;

use App\Models\customer_parts;

use App\Models\customer_services;

use Carbon\Carbon;

use DB;







class APIController extends Controller

{

    public function Register(Request $request)

    {

        $email = $request->email;

        $mobile_number = $request->mobile_number;

        $name = $request->name;

        $latitude = $request->latitude;

        $longitude = $request->longitude;

        $address = $request->address;

        $device_token = $request->firebase_token;

        $resendOTP = $request->resend_otp;



        $user = User::where('email', request('email'))

            ->orWhere('mobile_number', request('mobile_number'))

            ->first();

        if ($user) {

            if ($resendOTP == "yes") {

                $otp = $user->otp;

                $to = $user->email;

                $subject = "Send OTP for signup";

                $txt = "Your otp is " . $otp;

                //email template

                $txt = '<!doctype html>

 <html lang="en">

 <head>

   <meta charset="UTF-8">

   <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

   <meta http-equiv="X-UA-Compatible" content="ie=edge">

   <title>Mail</title>

 </head>

 <body><div style="font-family: Helvetica,Arial,sans-serif;min-width:1000px;overflow:auto;line-height:2">

  <div style="margin:50px auto;width:70%;padding:20px 0">

    <div style="border-bottom:1px solid #eee">

      <a href="" style="font-size:1.4em;color: #00466a;text-decoration:none;font-weight:600">imechano</a>

    </div>

    <p style="font-size:1.1em">Hi,</p>

    <p>Thank you for choosing imechano. Use the following OTP to complete your Sign Up procedures.</p>

    <h2 style="background: #70BCF0;margin: 0 auto;width: max-content;padding: 0 10px;color: #fff;border-radius: 4px;width: 50px;">' . $otp . '</h2>

    <p style="font-size:0.9em;">Regards,<br />imechano</p>

    <hr style="border:none;border-top:1px solid #eee" />

  </div>

</div></body></html>';

                $headers = "MIME-Version: 1.0" . "\r\n";

                $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";

                $headers .= "From: imanchnoimachno@gmail.com" . "\r\n" .

                    "CC: imanchnoimachno@gmail.com";



                if (mail($to, $subject, $txt, $headers)) {

                    return response()->json(['code' => 1, 'message' => 'OTP sent on your Email, Kindly check your email.']);

                } else {

                    return response()->json(['code' => 0, 'message' => 'Email not sent, Server issue.']);

                }







                // return response()->json(['code'=> 1,'message'=> 'OTP sent on your Email, Kindly check your email.']);



            } elseif ($user->email == $request->email) {

                return response()->json(['code' => 0, 'message' => 'Email is already registered, Kindly try with another one.']);



            } elseif ($user->mobile_number == $request->mobile_number) {



                return response()->json(['code' => 0, 'message' => 'Mobile number is already registered, Kindly try with another one.']);



            }

        } else {



            $otp = random_int(1000, 9999);



            $users = new User;

            $users->name = $request->name;

            $users->email = $request->email;

            $users->mobile_number = $request->mobile_number;

            $users->password = Hash::make($request['password']);

            $users->latitude = $request->latitude;

            $users->longitude = $request->longitude;

            $users->address = $request->address;

            $users->device_token = $device_token;

            // $users->device_token =  implode(",",$device_token);

            $users->role = "2";

            $users->otp = $otp;

            $users->save();





            $to = $users->email;

            $subject = "Send OTP for signup";

            $txt = "Your otp is " . $otp;

            //email template

            $txt = '<!doctype html>

 <html lang="en">

 <head>

   <meta charset="UTF-8">

   <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

   <meta http-equiv="X-UA-Compatible" content="ie=edge">

   <title>Mail</title>

 </head>

 <body><div style="font-family: Helvetica,Arial,sans-serif;min-width:1000px;overflow:auto;line-height:2">

  <div style="margin:50px auto;width:70%;padding:20px 0">

    <div style="border-bottom:1px solid #eee">

      <a href="" style="font-size:1.4em;color: #00466a;text-decoration:none;font-weight:600">imechano</a>

    </div>

    <p style="font-size:28px">Hi,</p>

    <p style="font-size:28px">Thank you for choosing imechano. Use the following OTP to complete your Sign Up procedures.</p>

    <h2 style="background:#70BCF0;margin:0 auto;padding:0 10px;color:#fff;border-radius:4px;width:150px; text-align: center; font-size: 40px;">' . $otp . '</h2>

    <p style="font-size:28px">Regards,<br />imechano</p>

    <hr style="border:none;border-top:1px solid #eee" />

  </div>

</div></body></html>';

            $headers = "MIME-Version: 1.0" . "\r\n";

            $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";

            $sender = 'noreplyt@imechano.com';

            $headers .= 'From:' . $sender . "\r\n";

            // $headers .= "From: imanchnoimachno@gmail.com" . "\r\n" .

            // "CC: imanchnoimachno@gmail.com";



            // mail($to,$subject,$txt,$headers);





            // $recipient = 'omaisali@@gmail.com';



            // $subject = "php mail test";

// $message = "php test message";



            // $headers  = "From: imechano@imechano.com \r\n";

// $headers .= "Reply-To: imechano@imechano.com\r\n";

// $headers .= "CC: imechano@gmail.com\r\n";

// $headers .= "MIME-Version: 1.0\r\n";

// $headers .= "Content-Type: text/html; charset=UTF-8\r\n";



            // if (mail($recipient, $subject, $message, $headers))

// {

//     echo "Message accepted";

// }

// else

// {

//     echo "Error: Message not accepted";

// }



            if (mail($to, $subject, $txt, $headers)) {

                return response()->json(['code' => 1, 'message' => 'OTP sent on your Email, Kindly check your email.']);

            } else {

                return response()->json(['code' => 0, 'message' => 'Email not sent, Server issue.']);

            }



            // return response()->json(['code'=> 1,'message'=> 'OTP sent on your Email, Kindly check your email.']);

        }



    }



    public function Otpverified(Request $request)

    {

        $email = $request->email;

        $flag = $request->flag;

        $otp = $request->otp;

        $user = User::where('email', request('email'))

            ->first();

        if ($user) {

            if ($user->otp == $request->otp) {

                if ($flag == 1) {

                    return response()->json(['code' => 1, 'message' => 'OTP Verified, Kindly update your password.']);



                } else {

                    return response()->json(['code' => 1, 'message' => 'Registered successfully!', 'data' => $user]);



                }



            } else {

                return response()->json(['code' => 0, 'message' => 'Entered OTP is wrong, Kindly check and re-enter it.']);



            }

        } else {

            return response()->json(['code' => 0, 'message' => 'This Email id is not register']);

        }



    }



    public function ForGotPassword(Request $request)

    {

        $email = $request->email;

        $mobile_number = $request->mobile_number;



        if ($email != null) {

            $user = User::where('email', request('email'))

                ->first();

            if ($user) {

                $otp = random_int(1000, 9999);



                // $users = User::find($user->id);

                // return $users;

                // $users->otp = $otp;

                // $users->save();

                

                User::where('id', $user->id)

            ->update([

                'otp' => $otp

            ]);

                

                $to = $user->email;

                $subject = "Send OTP for Reset Password";

                $txt1 = "Your otp is " . $otp;



                //email template

                $txt = '<!doctype html>

 <html lang="en">

 <head>

   <meta charset="UTF-8">

   <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

   <meta http-equiv="X-UA-Compatible" content="ie=edge">

   <title>Mail</title>

 </head>

 <body><div style="font-family: Helvetica,Arial,sans-serif;min-width:1000px;overflow:auto;line-height:2">

  <div style="margin:50px auto;width:70%;padding:20px 0">

    <div style="border-bottom:1px solid #eee">

      <a href="" style="font-size:1.4em;color: #00466a;text-decoration:none;font-weight:600">imechano</a>

    </div>

    <p style="font-size:1.1em">Hi,</p>

    <p>Use the following OTP to reset your Password</p>

    <h2 style="background: #70BCF0;margin: 0 auto;width: max-content;padding: 0 10px;color: #fff;border-radius: 4px;width: 50px;">' . $otp . '</h2>

    <p style="font-size:0.9em;">Regards,<br />imechano</p>

    <hr style="border:none;border-top:1px solid #eee" />

  </div>

</div></body></html>';

                $headers = "MIME-Version: 1.0" . "\r\n";

            $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";

            $sender = 'noreplyt@imechano.com';

            $headers .= 'From:' . $sender . "\r\n";

                    

                $mail =mail($to, $subject, $txt, $headers);

                    if(!$mail) {

                        // echo "Mailer Error: " . $mail->ErrorInfo;

                        $error = error_get_last();

                        return response()->json(['code' => 0, 'message' => 'Server Error. ']);

                      } else {

                        return response()->json(['code' => 1, 'message' => 'OTP sent on your Email, Kindly check your email.']);

                      }

                



            } else {

                return response()->json(['code' => 0, 'message' => 'This Email Id is does not exists']);

            }

        } elseif ($mobile_number != null) {

            return response()->json(['code' => 1, 'message' => 'OTP sent on your Mobile Number']);

        } else {

            return response()->json(['code' => 0, 'message' => 'Please, Enter Email or Mobile Number']);

        }



    }



    public function ResetPassword(Request $request)

    {

        $email = $request->email;

        $mobile_number = $request->mobile_number;

        $password = $request->password;





        $user = User::where('email', request('email'))

            ->first();

        if ($user) {

            $users = User::find($user->id);

            $users->password = Hash::make($request['password']);

            $users->save();

            return response()->json(['code' => 1, 'message' => 'Your Password is Changed Successfully!', 'data' => $users]);



        } else {

            return response()->json(['code' => 0, 'message' => 'This Email id is not register']);

        }



    }



    public function addProfileImage(Request $request)

    {

        $user = User::find($request->id);

        $path = "";

        if ($request->hasFile('image')) {



            $path = $request->file('image')->store('profiles');

            $user->profile = $path;

        }

        $user->save();

        return $path;

    }



    // public function Login(Request $request)

    // {

    //     $email = $request->email;

    //     $mobile_number = $request->mobile_number;

    //     $password = $request->password;



    //     if($email!=null){

    //         $user = User::where('email', request('email'))

    //     ->first();

    //     }else{

    //         $user = User::where('mobile_number', request('mobile_number'))

    //         ->first();



    //      }

    //     if($user){

    //         if(Hash::check(request('password'), $user->password)){

    //             return response()->json(['code'=> 1,'message'=>'Logged In successfully!','data'=> $user]);

    //         }else{

    //             return response()->json(['code'=> 0,'message'=>'Email or Password might be wrong']);

    //         }

    //     }else{

    //         return response()->json(['code'=> 0,'message'=>'This Mobile number is not register']);



    //     }





    // }

    public function Login(Request $request)

    {

        $email_mobile = $request->email_mobile;

        $password = $request->password;

        $device_token = $request->firebase_token;







        $user = User::where('mobile_number', request('email_mobile'))

            ->orWhere('email', request('email_mobile'))

            ->first();



        //$store_token=array($user->device_token);

        //array_push($store_token,$device_token);





        if ($user) {

            $user = User::find($user->id);

            //$user->device_token =  implode(",",$store_token);

            $user->device_token = $device_token;

            $user->save();

            if (Hash::check(request('password'), $user->password)) {

                $user = User::where('mobile_number', request('email_mobile'))

                    ->orWhere('email', request('email_mobile'))

                    ->first();

                return response()->json(['code' => 1, 'message' => 'Logged In successfully!', 'data' => $user]);

            } else {



                return response()->json(['code' => 0, 'message' => 'Email or Password might be wrong']);

            }

        } else {

            return response()->json(['code' => 0, 'message' => 'This user is not register']);



        }





    }



    public function CarBrand(Request $request)

    {

        $brands = car_brands::get();

        foreach ($brands as $brand) {

            $brand->logo = url('storage/' . $brand->logo);

        }

        return response()->json(['code' => 1, 'message' => 'Brand details', 'data' => $brands]);



    }



    public function Brandmodel(Request $request)

    {

        $brand_id = $request->brand_id;

        $models = car_models::where('brand_id', $brand_id)->get();

        foreach ($models as $model) {

            $model->image = url('storage/' . $model->image);

        }

        return response()->json(['code' => 1, 'message' => 'Brand Model details', 'data' => $models]);



    }

    public function CategoryList(Request $request)
    {
        if($request->search){
            $data = DB::select("
            ( SELECT t1.*, items.id as item_id, items.item as item_name, service_subcategories.name as subcategory_name, service_subcategories.id as subcategory_id FROM service_categories t1 JOIN service_subcategories ON t1.id = service_subcategories.category_id JOIN items ON service_subcategories.id = items.sub_category_id WHERE items.item LIKE '%".$request->search."%' OR  items.item_ar LIKE '%".$request->search."%' ) UNION ALL ( SELECT t1.*, null as item_id, '' as item_name, service_subcategories.name as subcategory_name, service_subcategories.id as subcategory_id FROM service_categories t1 JOIN service_subcategories ON t1.id = service_subcategories.category_id WHERE service_subcategories.name LIKE '%".$request->search."%' OR service_subcategories.name_ar LIKE '%".$request->search."%' )  UNION ALL ( SELECT t1.*, null as item_id, '' as item_name, '' as subcategory_name, null as subcategory_id FROM service_categories t1 WHERE t1.category_name LIKE '%".$request->search."%' OR t1.categoy_name_ar LIKE '%".$request->search."%')  ORDER BY id"
            );
            foreach ($data as $category) {
                $category->icon = url('storage/' . $category->icon);
            }
        }else{
            $data = service_categories::select('id', 'icon', 'category_name', 'created_at', 'updated_at', 'deleted_at');
            $data = $data->take(8)->orderBy('id', 'asc')->get();
            foreach ($data as $category) {
                $category->subcategory_name  = "";
                    $category->subcategory_id = null;
                    $category->item_name  = "";
                    $category->item_id = null;
                $category->icon = url('storage/' . $category->icon);
            }
        }
        

        

        return response()->json(['code' => 1, 'message' => 'Category details', 'data' => $data]);


    }
    
    
    //Adding New Items in Database for Others 
     public function AddOtherItems(Request $request){
         
  

items::create([
    'id' => $request->itemId,
    'sub_category_id' => '10013',
    'item' =>$request->itemName
]);
         return response()->json(['code' => 1, 'message' => 'Other Added']);

         
     }
    

    public function CategoryList2(Request $request)

    {

        $data = service_categories::select('id', 'icon', 'category_name', 'created_at', 'updated_at', 'deleted_at');
        $subdata = service_subcategories::select('id', 'category_id', 'name', 'created_at', 'updated_at', 'deleted_at');
        $itemdata = items::select('id', 'sub_category_id', 'item', 'description', 'created_at', 'updated_at', 'deleted_at');

        $subcategory_ids = array();
        $item_ids =array();
        $item_count = 0;
        $subcount = 0;
        $count = 0;
        if ($request->search) {

            $itemdata->where('item', 'Like', '%' . $request->search . '%');
            $item_count = $itemdata->count();

            
            if($item_count>0){

                $itemdata = $itemdata->orderBy('id', 'asc')->get();
                foreach ($itemdata as $item) {

                    $subcategory_ids[] = $item->sub_category_id;
    
                }
    
                $subdata = $subdata->whereIn('id', $subcategory_ids);

                $subdata->where('name', 'Like', '%' . $request->search . '%');
                $subcount = $subdata->count();

                if($subcount>0){

                    $subdata = $subdata->orderBy('id', 'asc')->get();
                    foreach ($subdata as $subcategory) {
    
                        $subcategory_ids[] = $subcategory->category_id;
        
                    }
        
                    $data = $data->whereIn('id', $subcategory_ids);

                }else{
                    $itemdata = $itemdata->orderBy('id', 'asc')->get();
                    $subdata = $subdata->orderBy('id', 'asc')->get();
                    $data->where('category_name', 'Like', '%' . $request->search . '%');
    
                }
                

            }else{
                $subdata->where('name', 'Like', '%' . $request->search . '%');
                $subcount = $subdata->count();
                if($count>0){

                    $subdata = $subdata->orderBy('id', 'asc')->get();
                    foreach ($subdata as $subcategory) {
    
                        $subcategory_ids[] = $subcategory->category_id;
        
                    }
        
                    $data = $data->whereIn('id', $subcategory_ids);

                }else{
                    $itemdata = $itemdata->orderBy('id', 'asc')->get();
                    $subdata = $subdata->orderBy('id', 'asc')->get();
                    $data->where('category_name', 'Like', '%' . $request->search . '%');
                    $count = $data->count();
    
                }
            }
                

            
            

        }


        $data = $data->take(7)->orderBy('id', 'asc')->get();
        


            foreach ($data as $category) {

                $category->subcategory_name  = "";
                $category->subcategory_id = null;
                $category->item_name  = "";
                $category->item_id = null;

                $category->icon = url('storage/' . $category->icon);

                foreach ($subdata as $subcategory) {
                    if($subcategory->category_id == $category->id){
                        $category->subcategory_id = $subcategory->id;
                        $category->subcategory_name = $subcategory->name;
                    }

                    foreach ($itemdata as $item) {
                        if($item->sub_category_id == $subcategory->id){
                            $category->item_id = $item->id;
                            $category->item_name = $item->item;
                        }
    
                    }

                }


            }

        return response()->json(['code' => 1, 'message' => 'Category details', 'data' => $data, 'items' => $item_count, 'subcategories' => $count]);



    }

    public function SubCategoryList(Request $request)

    {

        $category_id = $request->category_id;

        $subcategories = service_subcategories::where('category_id', $category_id)->get();

        return response()->json(['code' => 1, 'message' => 'Sub Category details', 'data' => $subcategories]);



    }

    public function ItemList(Request $request)

    {

        $sub_category_id = $request->sub_category_id;

        $items = items::where('sub_category_id', $sub_category_id)->get();

        return response()->json(['code' => 1, 'message' => 'Item details', 'data' => $items]);



    }


    public function AddCar(Request $request)

    {

        $cars = new cars;

        $cars->user_id = $request->user_id;

        $cars->brand_id = $request->brand_id;

        $cars->model = $request->model;

        $cars->cylinder = $request->cylinder;

        $cars->mileage = $request->mileage;

        $cars->model_year = $request->model_year;

        $cars->plate_number = $request->plate_number;

        $cars->chases_number = $request->chases_number;

        $cars->fuel_type = $request->fuel_type;

        $cars->save();

        return response()->json(['code' => 1, 'message' => 'Car added successfyully', 'data' => $cars]);



    }


    public function EditCar(Request $request)

    {

        $cars = cars::find($request->id);

        $cars->user_id = $request->user_id;

        $cars->brand_id = $request->brand_id;

        $cars->model = $request->model;

        $cars->cylinder = $request->cylinder;

        $cars->mileage = $request->mileage;

        $cars->model_year = $request->model_year;

        $cars->plate_number = $request->plate_number;

        $cars->chases_number = $request->chases_number;

        $cars->fuel_type = $request->fuel_type;

        $cars->save();

        return response()->json(['code' => 1, 'message' => 'Car updated successfully', 'data' => $cars]);



    }







    public function DeleteCar(Request $request)

    {





        $cars = cars::find($request->id);

        if ($cars) {

            $cars->delete();

            return response()->json(['code' => 1, 'message' => 'Car deleted  successfyully']);



        } else {

            return response()->json(['code' => 0, 'message' => 'This Id doesnot exists']);



        }



    }

    public function CarImage(Request $request){
        $id=$request->id;
        $imag =car_models::where('model', $id)->first();
    
    
    return response()->json(['code' => 1,  'data' => $imag]);

        
    }

    public function CarList(Request $request)

    {



        $user_id = $request->user_id;

        $cars = cars::where('user_id', $user_id)->get();
        
        $id="";
        foreach($cars as $car){
            

        $model_image=car_models::select('image')->where('model',"=",$car->model)->first();
        
        $car['image']=$model_image['image'];
            
        }
        


        return response()->json(['code' => 1, 'message' => 'car List', 'data' => $cars]);

    }





    public function SelectCarDetails(Request $request)

    {

        $car_id = $request->car_id;

        $cars = cars::where('id', $car_id)->first();
        
        $model_image=car_models::select('image')->where('model',"=","A1")->first();
        $cars['image']=$model_image['image'];


        return response()->json(['code' => 1, 'message' => 'Car Details', 'data' => $cars]);

    }



    public function Userprofile(Request $request)

    {



        $user_id = $request->user_id;



        $users = User::find($user_id);



        if ($users) {

            $users = User::find($user_id);

            $users->name = $request->name;

            $users->email = $request->email;

            $users->mobile_number = $request->mobile_number;

            $users->dob = $request->dob;

            $users->gender = $request->gender;



            if ($request->hasFile('profile')) {

                $fileNameExt = $request->file('profile')->getClientOriginalName();

                $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

                $fileExt = $request->file('profile')->getClientOriginalExtension();

                $fileNameToStore = $fileName . '_' . time() . '.' . $fileExt;

                $pathToStore = $request->file('profile')->storeAs('public', $fileNameToStore);

                $users->profile = $fileNameToStore;

            }



            $users->save();

            $users->profile = url('/storage/' . $users->profile);

            return response()->json(['code' => 1, 'message' => 'profile updated successfully', 'data' => $users]);



        } else {

            return response()->json(['code' => 0, 'message' => 'This Id doesnot exists']);



        }





    }





    public function ViewUserprofile(Request $request)

    {

        $user_id = $request->user_id;



        $users = User::find($user_id);

        if ($users) {

            return response()->json(['code' => 1, 'message' => 'User profile data', 'data' => $users]);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Id doesnot exists']);

        }



    }



    public function CarBooking(Request $request)

    {

        $booking_id = random_int(100000, 999999);



        do {

            $booking_id = random_int(100000, 999999);

        } while (customer_bookings::where('booking_id', $booking_id)->exists());



        $cars = cars::where('id', $request->car_id)->first();

        if ($cars) {

            $bookings = new customer_bookings;

            $bookings->booking_id = $booking_id;

            $bookings->car_id = $request->car_id;

            $bookings->customer_id = $request->customer_id;

            $bookings->category_id = $request->category_id;

            $bookings->sub_category_id = $request->sub_category_id;

            $bookings->item_id = implode(",", $request->item_id);

            $bookings->time_date = $request->time_date;

            $bookings->address = $request->address;

            $bookings->total = $request->total;

            $bookings->status = "0";



            if ($request->hasFile('car_upload')) {

                $fileNameExt = $request->file('car_upload')->getClientOriginalName();

                $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

                $fileExt = $request->file('car_upload')->getClientOriginalExtension();

                $fileNameToStore = $fileName . '_' . time() . '.' . $fileExt;

                $pathToStore = $request->file('car_upload')->storeAs('public', $fileNameToStore);

                $bookings->car_upload = $fileNameToStore;

            }

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            $cars = cars::find($bookings->car_id);

            if ($cars) {

                $car_name = $cars->model;

            } else {

                $car_name = "Car";

            }



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->get();

            //$firebaseToken = User::select('device_token')->where('email','admin@gmail.com')->where('role','=',null)->first();

            //$firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

            // $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            $token_array = explode(',', $firebaseToken[0]['device_token']);

            // $deviceToken = array_values($token_array);

            // return response()->json(['code'=> 1,'message'=>$firebaseToken[0]['device_token'],'data'=>$bookings]);



            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $token_array,
                
                
                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "New Booking",

                    "screen" => "screenA",

                ],
                
                
                
                

                "notification" => [

                    "title" => 'New Booking',

                    "body" => $user_name . ' has placed a booking, please review!',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];







            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



            $response = curl_exec($ch);





            $subcategories = service_subcategories::find($bookings->sub_category_id);

            $items = items::whereIn('id', explode(",", $bookings->item_id))->orderBy('updated_at', 'desc')->get();

            $bookings['subcategory_name'] = $subcategories->name;

            $bookings['items'] = $items;



            $notifications = new Notifications;

            $notifications->car_id = $request->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'New Booking';

            $notifications->message = $user_name . ' has placed a booking, please review!';

            $notifications->save();



            $itemIds = explode(',', $bookings->item_id);





            foreach ($itemIds as $id) {



                $item = DB::table('items')->where('id', $id)->first();





                try {

                    $query = DB::table('customer_items')->insert(

                        [

                            'item_id' => $id,

                            'booking_id' => $booking_id,

                            'name' => $item->item,

                            'description' => $item->description,

                        ]

                    ); // Closures include ->first(), ->get(), ->pluck(), etc.

                } catch (\Illuminate\Database\QueryException $ex) {

                    // dd($ex->getMessage()); 

                    // Note any method of class PDOException can be called on $ex.

                    return response()->json(['code' => 1, 'message' => 'Booking not successfully', 'data' => $ex->getMessage()]);

                }







            }





            return response()->json(['code' => 1, 'message' => 'Booking request sent to Admin ', 'data' => $bookings]);



        } else {

            return response()->json(['code' => 0, 'message' => 'Please,First add your car details.']);



        }









    }





    public function EmergencyBooking(Request $request)

    {

        

        $booking_id = random_int(100000, 999999);



        $request->category_id = "12";

        $request->sub_category_id = "50";

        $request->item_id = "23";

        $request->total = "100";



        do {

            $booking_id = random_int(100000, 999999);

        } while (customer_bookings::where('booking_id', $booking_id)->exists());



        $cars = cars::where('id', $request->car_id)->first();

        if ($cars) {

            $bookings = new customer_bookings;

            $bookings->booking_id = $booking_id;

            $bookings->car_id = $request->car_id;

            $bookings->customer_id = $request->customer_id;

            $bookings->category_id = $request->category_id;

            $bookings->sub_category_id = $request->sub_category_id;

            $bookings->item_id = $request->item_id;

            $bookings->time_date = $request->time_date;

            $bookings->address = $request->address;

            $bookings->total = $request->total;

            $bookings->status = "0";



            if ($request->description) {                

                $count = count($request->file('images'));

                $work_image = "";

                for ($i = 0; $i < $count; $i++) {

                    $fileNameExt = $request->file('images')[$i]->getClientOriginalName();

                    $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

                    $fileExt = $request->file('images')[$i]->getClientOriginalExtension();

                    $fileNameToStore = $fileName . '_' . time() . '.' . $fileExt;

                    $pathToStore = $request->file('images')[$i]->storeAs('public', $fileNameToStore);

                    $work_image = $work_image . "" . $fileNameToStore . ",";

                }



                $bookings->car_upload = $work_image;

                $bookings->description = $request->description;

                

            }



            // if ($request->hasFile('car_upload')) {

            //     $fileNameExt = $request->file('car_upload')->getClientOriginalName();

            //     $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

            //     $fileExt = $request->file('car_upload')->getClientOriginalExtension();

            //     $fileNameToStore = $fileName . '_' . time() . '.' . $fileExt;

            //     $pathToStore = $request->file('car_upload')->storeAs('public', $fileNameToStore);

            //     $bookings->car_upload = $fileNameToStore;

            // }

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            $cars = cars::find($bookings->car_id);

            if ($cars) {

                $car_name = $cars->model;

            } else {

                $car_name = "Car";

            }



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->get();

            //$firebaseToken = User::select('device_token')->where('email','admin@gmail.com')->where('role','=',null)->first();

            //$firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

            // $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            $token_array = explode(',', $firebaseToken[0]['device_token']);

            // $deviceToken = array_values($token_array);

            // return response()->json(['code'=> 1,'message'=>$firebaseToken[0]['device_token'],'data'=>$bookings]);



            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Emergency Booking',

                    "body" => $user_name . ' has placed a booking, please review!',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];







            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



            $response = curl_exec($ch);





            $subcategories = service_subcategories::find($bookings->sub_category_id);

            $items = items::whereIn('id', explode(",", $bookings->item_id))->orderBy('updated_at', 'desc')->get();

            $bookings['subcategory_name'] = $subcategories->name;

            $bookings['items'] = $items;



            $notifications = new Notifications;

            $notifications->car_id = $request->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Emergency Booking';

            $notifications->message = $user_name . ' has placed a booking, please review!';

            $notifications->save();



            $itemIds = explode(',', $bookings->item_id);





            foreach ($itemIds as $id) {



                $item = DB::table('items')->where('id', $id)->first();





                try {

                    $query = DB::table('customer_items')->insert(

                        [

                            'item_id' => $id,

                            'booking_id' => $booking_id,

                            'name' => $item->item,

                            'description' => $item->description,

                        ]

                    ); // Closures include ->first(), ->get(), ->pluck(), etc.

                } catch (\Illuminate\Database\QueryException $ex) {

                    // dd($ex->getMessage()); 

                    // Note any method of class PDOException can be called on $ex.

                    return response()->json(['code' => 1, 'message' => 'Booking not successfully', 'data' => $ex->getMessage()]);

                }







            }





            return response()->json(['code' => 1, 'message' => 'Booking successfully', 'data' => $bookings]);



        } else {

            return response()->json(['code' => 0, 'message' => 'Please,First add your car details.']);



        }









    }



    public function CarCheckupBooking(Request $request)

    {

        

        $booking_id = random_int(100000, 999999);



        $request->category_id = "13";

        $request->sub_category_id = "99";

        $request->item_id = "99";

        $request->total = "100";



        do {

            $booking_id = random_int(100000, 999999);

        } while (customer_bookings::where('booking_id', $booking_id)->exists());



        $cars = cars::where('id', $request->car_id)->first();

        if ($cars) {

            $bookings = new customer_bookings;

            $bookings->booking_id = $booking_id;

            $bookings->car_id = $request->car_id;

            $bookings->customer_id = $request->customer_id;

            $bookings->category_id = $request->category_id;

            $bookings->sub_category_id = $request->sub_category_id;

            $bookings->item_id = $request->item_id;

            $bookings->time_date = $request->time_date;

            $bookings->address = $request->address;

            $bookings->total = $request->total;

            $bookings->status = "0";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            $cars = cars::find($bookings->car_id);

            if ($cars) {

                $car_name = $cars->model;

            } else {

                $car_name = "Car";

            }



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->get();

            //$firebaseToken = User::select('device_token')->where('email','admin@gmail.com')->where('role','=',null)->first();

            //$firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

            // $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            $token_array = explode(',', $firebaseToken[0]['device_token']);

            // $deviceToken = array_values($token_array);

            // return response()->json(['code'=> 1,'message'=>$firebaseToken[0]['device_token'],'data'=>$bookings]);



            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Car Checkup Booking',

                    "body" => $user_name . ' has placed a booking, please review!',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];







            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



            $response = curl_exec($ch);





            $subcategories = service_subcategories::find($bookings->sub_category_id);

            $items = items::whereIn('id', explode(",", $bookings->item_id))->orderBy('updated_at', 'desc')->get();

            $bookings['subcategory_name'] = $subcategories->name;

            $bookings['items'] = $items;



            $notifications = new Notifications;

            $notifications->car_id = $request->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Car Checkup Booking';

            $notifications->message = $user_name . ' has placed a booking, please review!';

            $notifications->save();



            $itemIds = explode(',', $bookings->item_id);





            foreach ($itemIds as $id) {



                $item = DB::table('items')->where('id', $id)->first();





                try {

                    $query = DB::table('customer_items')->insert(

                        [

                            'item_id' => $id,

                            'booking_id' => $booking_id,

                            'name' => $item->item,

                            'description' => $item->description,

                        ]

                    ); // Closures include ->first(), ->get(), ->pluck(), etc.

                } catch (\Illuminate\Database\QueryException $ex) {

                    // dd($ex->getMessage()); 

                    // Note any method of class PDOException can be called on $ex.

                    return response()->json(['code' => 1, 'message' => 'Booking not successfully', 'data' => $ex->getMessage()]);

                }







            }





            return response()->json(['code' => 1, 'message' => 'Booking successfully', 'data' => $bookings]);



        } else {

            return response()->json(['code' => 0, 'message' => 'Please,First add your car details.']);



        }









    }



    public function QuickServiceBooking(Request $request)

    {

        

        $booking_id = random_int(100000, 999999);



        $request->category_id = "16";

        $request->sub_category_id = "1001";

        $request->item_id = "10211";

        $request->total = "100";



        do {

            $booking_id = random_int(100000, 999999);

        } while (customer_bookings::where('booking_id', $booking_id)->exists());



        $cars = cars::where('id', $request->car_id)->first();

        if ($cars) {

            $bookings = new customer_bookings;

            $bookings->booking_id = $booking_id;

            $bookings->car_id = $request->car_id;

            $bookings->customer_id = $request->customer_id;

            $bookings->category_id = $request->category_id;

            $bookings->sub_category_id = $request->sub_category_id;

            $bookings->item_id = $request->item_id;

            $bookings->time_date = $request->time_date;

            $bookings->address = $request->address;

            $bookings->total = $request->total;

            $bookings->status = "0";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            $cars = cars::find($bookings->car_id);

            if ($cars) {

                $car_name = $cars->model;

            } else {

                $car_name = "Car";

            }



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->get();

            //$firebaseToken = User::select('device_token')->where('email','admin@gmail.com')->where('role','=',null)->first();

            //$firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

            // $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            $token_array = explode(',', $firebaseToken[0]['device_token']);

            // $deviceToken = array_values($token_array);

            // return response()->json(['code'=> 1,'message'=>$firebaseToken[0]['device_token'],'data'=>$bookings]);



            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Quick Service Booking',

                    "body" => $user_name . ' has placed a booking, please review!',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];







            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



            $response = curl_exec($ch);





            $subcategories = service_subcategories::find($bookings->sub_category_id);

            $items = items::whereIn('id', explode(",", $bookings->item_id))->orderBy('updated_at', 'desc')->get();

            $bookings['subcategory_name'] = $subcategories->name;

            $bookings['items'] = $items;



            $notifications = new Notifications;

            $notifications->car_id = $request->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Quick Service Booking';

            $notifications->message = $user_name . ' has placed a booking, please review!';

            $notifications->save();



            $itemIds = explode(',', $bookings->item_id);





            foreach ($itemIds as $id) {



                $item = DB::table('items')->where('id', $id)->first();





                try {

                    $query = DB::table('customer_items')->insert(

                        [

                            'item_id' => $id,

                            'booking_id' => $booking_id,

                            'name' => $item->item,

                            'description' => $item->description,

                        ]

                    ); // Closures include ->first(), ->get(), ->pluck(), etc.

                } catch (\Illuminate\Database\QueryException $ex) {

                    // dd($ex->getMessage()); 

                    // Note any method of class PDOException can be called on $ex.

                    return response()->json(['code' => 1, 'message' => 'Booking not successfully', 'data' => $ex->getMessage()]);

                }







            }





            return response()->json(['code' => 1, 'message' => 'Booking successfully', 'data' => $bookings]);



        } else {

            return response()->json(['code' => 0, 'message' => 'Please,First add your car details.']);



        }









    }



    public function CarDetailingBooking(Request $request)

    {

        

        $booking_id = random_int(100000, 999999);



        $request->category_id = "19";

        $request->sub_category_id = "5515";

        $request->item_id = "5505";

        $request->total = "100";



        do {

            $booking_id = random_int(100000, 999999);

        } while (customer_bookings::where('booking_id', $booking_id)->exists());



        $cars = cars::where('id', $request->car_id)->first();

        if ($cars) {

            $bookings = new customer_bookings;

            $bookings->booking_id = $booking_id;

            $bookings->car_id = $request->car_id;

            $bookings->customer_id = $request->customer_id;

            $bookings->category_id = $request->category_id;

            $bookings->sub_category_id = $request->sub_category_id;

            $bookings->item_id = $request->item_id;

            $bookings->time_date = $request->time_date;

            $bookings->address = $request->address;

            $bookings->total = $request->total;

            $bookings->status = "0";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            $cars = cars::find($bookings->car_id);

            if ($cars) {

                $car_name = $cars->model;

            } else {

                $car_name = "Car";

            }



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->get();

            //$firebaseToken = User::select('device_token')->where('email','admin@gmail.com')->where('role','=',null)->first();

            //$firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

            // $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            $token_array = explode(',', $firebaseToken[0]['device_token']);

            // $deviceToken = array_values($token_array);

            // return response()->json(['code'=> 1,'message'=>$firebaseToken[0]['device_token'],'data'=>$bookings]);



            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Car Detailing Booking',

                    "body" => $user_name . ' has placed a booking, please review!',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];







            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



            $response = curl_exec($ch);





            $subcategories = service_subcategories::find($bookings->sub_category_id);

            $items = items::whereIn('id', explode(",", $bookings->item_id))->orderBy('updated_at', 'desc')->get();

            $bookings['subcategory_name'] = $subcategories->name;

            $bookings['items'] = $items;



            $notifications = new Notifications;

            $notifications->car_id = $request->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Car Detailing Booking';

            $notifications->message = $user_name . ' has placed a booking, please review!';

            $notifications->save();



            $itemIds = explode(',', $bookings->item_id);





            foreach ($itemIds as $id) {



                $item = DB::table('items')->where('id', $id)->first();





                try {

                    $query = DB::table('customer_items')->insert(

                        [

                            'item_id' => $id,

                            'booking_id' => $booking_id,

                            'name' => $item->item,

                            'description' => $item->description,

                        ]

                    ); // Closures include ->first(), ->get(), ->pluck(), etc.

                } catch (\Illuminate\Database\QueryException $ex) {

                    // dd($ex->getMessage()); 

                    // Note any method of class PDOException can be called on $ex.

                    return response()->json(['code' => 1, 'message' => 'Booking not successfully', 'data' => $ex->getMessage()]);

                }







            }





            return response()->json(['code' => 1, 'message' => 'Booking successfully', 'data' => $bookings]);



        } else {

            return response()->json(['code' => 0, 'message' => 'Please,First add your car details.']);



        }









    }



    public function CancelBooking(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {

            $bookings->status = "2";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            $cars = cars::find($bookings->car_id);

            if ($cars) {

                $car_name = $cars->model;

            } else {

                $car_name = "Car";

            }



            //   $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

            // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

            $token_array = explode(',', $firebaseToken->device_token);

            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Cancel Booking',

                    "body" => $user_name . ' has cancel a booking, please review!',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];



            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



            $response = curl_exec($ch);





            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Cancel Booking';

            $notifications->message = $user_name . ' has cancel a booking, please review!';

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Booking Cancel successfyully']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }


    public function CustomerInvoice(Request $request){
        
        if ($request->status == "3") {

            $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "2")
            
                ->orderBy('updated_at', 'desc')->get();
                
            $bookings = customer_bookings::where('booking_id', $request->booking_id)->where('status', '=', "0")->where('admin_status', '=', "2")->where('payment_status','<>',NULL)

                ->orderBy('updated_at', 'desc')->get();
            
                

            if (strlen($request->end_date) > 2) {

                $start_date = Carbon::parse($request->start_date)->toDateTimeString();

                $end_date = Carbon::parse($request->end_date)->toDateTimeString();




                $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "1")->

                    whereBetween('created_at', [

                        $start_date,

                        $end_date

                    ])->get();

            }
            
            if (strlen($request->search) > 5) {


                $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "1")->orWhere('admin_status', '=', "2")->

                    where('booking_id','=',$request->search )->get();

            }

            foreach ($bookings as $booking) {
                
                $job_card_status=job_cards::select('status')->where('booking_id',$booking->booking_id)->first()['status'];
                
                $booking['job_card_status']=$job_card_status;
                // $booking["car"]=car::select('model')->where("user_id","$request->customer_id")->first();

                $subcategories = service_subcategories::find($booking->sub_category_id);

                if (strlen($request->search) > 1) {



                    // Search sub Category

                    if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

                        $booking['subcategory_name'] = $subcategories->name;

                        $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                        $booking['items'] = $items;

                    }



                    //Search by Car Number

                    $cars = cars::find((int) $booking->car_id);

                    if ($cars)

                        if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

                            $booking['subcategory_name'] = $subcategories->name;

                            $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                            $booking['items'] = $items;

                            $booking['cars'] = $cars;

                        }



                } else {



                    $booking['subcategory_name'] = $subcategories->name;

                    $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                    $booking['items'] = $items;

                }

            }
            

        }
        //Cars 
        foreach($bookings as $booking){
            
            
            
            $model= cars::select('model')->where("id","$booking->car_id")->first()['model'];
            $brand_id=car_models::select('brand_id')->where("model",$model)->first()['brand_id'];
        
           $brand=car_brands::select('brand')->where("id",$brand_id)->first()['brand'];
           $car=cars::where("id","$booking->car_id")->first();
           $car["brand"]=$brand;
            $booking['car_details']=$car;


            
            
            
            
        }
        
       
        


        return response()->json(['code' => 1, 'message' => 'Customer Invoice', 'data' =>$bookings]);
        
    }

    public function BookingList(Request $request)

    {
            //Startttt
        if ($request->status == "3") {


            $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "1")->orWhere('admin_status', '=', "2")
                ->orderBy('updated_at', 'desc')->get();
                

            if (strlen($request->end_date) > 2) {

                $start_date = Carbon::parse($request->start_date)->format('Y-m-d 00:00:00');

                $end_date = Carbon::parse($request->end_date)->format('Y-m-d 23:59:59');
            
            
            if ($start_date === $end_date) {
                  $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "1")->orWhere('admin_status', '=', "2")->

                    whereDate('created_at', $start_date)->get();
            }
            else{
                
                  $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "1")->orWhere('admin_status', '=', "2")->

                    whereBetween('created_at', [

                        $start_date,

                        $end_date

                    ])->get();
            }



              

            }
            
            if (strlen($request->search) > 1000) {


                $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', '=', "0")->where('admin_status', '=', "1")->orWhere('admin_status', '=', "2")->

                    where('booking_id','=',$request->search )->get();

            }

            foreach ($bookings as $booking) {
                
                
                
                // $booking["car"]=car::select('model')->where("user_id","$request->customer_id")->first();

                $subcategories = service_subcategories::find($booking->sub_category_id);

                if (strlen($request->search) > 1) {



                    // Search sub Category

                    if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

                        $booking['subcategory_name'] = $subcategories->name;

                        $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                        $booking['items'] = $items;

                    }



                    //Search by Car Number

                    $cars = cars::find((int) $booking->car_id);

                    if ($cars)

                        if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

                            $booking['subcategory_name'] = $subcategories->name;

                            $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                            $booking['items'] = $items;

                            $booking['cars'] = $cars;

                        }



                } else {



                    $booking['subcategory_name'] = $subcategories->name;

                    $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                    $booking['items'] = $items;

                }

            }
//ENDDDDD
        } else if ($request->status == "0") {



            $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)

                ->where('admin_status', '=', "0")->orderBy('updated_at', 'desc')->get();



            if (strlen($request->end_date) > 2) {

                $start_date = Carbon::parse($request->start_date)->format('Y-m-d 00:00:00');

                $end_date = Carbon::parse($request->end_date)->format('Y-m-d 23:59:59');
            

                if ($start_date === $end_date) {
                    
                     $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)

                    ->where('admin_status', '=', "0")->

                    whereDate('created_at',' $start_date')->get();

}
else{
      $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)

                    ->where('admin_status', '=', "0")->

                    whereBetween('created_at', [

                        $start_date,

                        $end_date

                    ])->get();
}


              

            }



            foreach ($bookings as $booking) {

                $subcategories = service_subcategories::find($booking->sub_category_id);





                if (strlen($request->search) > 1) {

                    // Search sub Category

                    if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

                        $booking['subcategory_name'] = $subcategories->name;

                        $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                        $booking['items'] = $items;

                    }



                    //Search by Car Number

                    $cars = cars::find((int) $booking->car_id);

                    if ($cars)

                        if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

                            $booking['subcategory_name'] = $subcategories->name;

                            $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                            $booking['items'] = $items;

                            $booking['cars'] = $cars;

                        }





                } else {

                    $booking['subcategory_name'] = $subcategories->name;

                    $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                    $booking['items'] = $items;

                }

            }

        } else if ($request->status == "1") {



            $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)

                ->where('admin_status', '=', "1")->where('payment_status', '=', "1")->orderBy('updated_at', 'desc')->get();



            if (strlen($request->end_date) > 2) {

                $start_date = Carbon::parse($request->start_date)->toDateTimeString();

                $end_date = Carbon::parse($request->end_date)->toDateTimeString();



                $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)

                    ->where('admin_status', '=', "1")->where('payment_status', '=', "1")->

                    whereBetween('created_at', [

                        $start_date,

                        $end_date

                    ])->get();

            }



            foreach ($bookings as $booking) {

                $subcategories = service_subcategories::find($booking->sub_category_id);

                if (strlen($request->search) > 1) {

                    // Search sub Category

                    if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

                        $booking['subcategory_name'] = $subcategories->name;

                        $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                        $booking['items'] = $items;

                    }



                    //Search by Car Number

                    $cars = cars::find((int) $booking->car_id);

                    if ($cars)

                        if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

                            $booking['subcategory_name'] = $subcategories->name;

                            $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                            $booking['items'] = $items;

                            $booking['cars'] = $cars;

                        }





                } else {

                    $booking['subcategory_name'] = $subcategories->name;

                    $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                    $booking['items'] = $items;

                }

            }

        } else if ($request->status == "2") {



            $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)

                ->orderBy('updated_at', 'desc')->get();



            if (strlen($request->end_date) > 2) {

                $start_date = Carbon::parse($request->start_date)->toDateTimeString();

                $end_date = Carbon::parse($request->end_date)->toDateTimeString();



                $bookings = customer_bookings::where('customer_id', $request->customer_id)->where('status', $request->status)->

                    whereBetween('created_at', [

                        $start_date,

                        $end_date

                    ])->get();

            }



            foreach ($bookings as $booking) {

                $subcategories = service_subcategories::find($booking->sub_category_id);

                if (strlen($request->search) > 1) {

                    // Search sub Category

                    if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

                        $booking['subcategory_name'] = $subcategories->name;

                        $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                        $booking['items'] = $items;

                    }



                    //Search by Car Number

                    $cars = cars::find((int) $booking->car_id);

                    if ($cars)

                        if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

                            $booking['subcategory_name'] = $subcategories->name;

                            $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                            $booking['items'] = $items;

                            $booking['cars'] = $cars;

                        }





                } else {

                    $booking['subcategory_name'] = $subcategories->name;

                    $items = items::whereIn('id', explode(",", $booking->item_id))->get();

                    $booking['items'] = $items;

                }

            }

        }
        
        
        foreach($bookings as $booking){
            
            
           
        $booking['customer']= User::select('name','mobile_number','longitude','latitude')->where('id',$booking->customer_id)->first();
            
            
            $model= cars::select('model','model_year','chases_number')->where("id","$booking->car_id")->first();
            $brand_id=car_models::select('brand_id')->where("model",$model['model'])->first()['brand_id'];
        
           $brand=car_brands::select('brand')->where("id",$brand_id)->first()['brand'];
           
           $booking['car_brand']=$brand;
            $booking['car_model']=$model['model'];
            $booking['car_year']=$model[
                'model_year'];
            $booking['car_chasis']=$model['chases_number'];

           
           
           $booking["car_name"]=$brand." ".$model['model'];
        
            
            
            
            
        }
        
       
        


        return response()->json(['code' => 1, 'message' => 'Booking Detail', 'data' =>$bookings,'stat'=>$request->start_date,'end'=>$request->end_date]);




    }







    public function CustomerData(Request $request)

    {

        $bookings = customer_bookings::select('id', 'booking_id', 'customer_id', 'garage_id')->paginate(20);

        foreach ($bookings as $booking) {



            $customer = User::find($booking->customer_id);

            if ($customer) {

                $booking['customer_name'] = $customer->name;

                $booking['mobile_number'] = $customer->mobile_number;

            } else {

                $booking['customer_name'] = "";

                $booking['mobile_number'] = "";

            }



            $garages = garages::find($booking->garage_id);

            if ($garages) {

                $booking['garage_profile'] = $garages->garage_profile;

            } else {

                $booking['garage_profile'] = "";



            }

        }

        return response()->json(['code' => 1, 'message' => 'customer data', 'data' => $bookings]);



    }

    public function CustomerDetails(Request $request)

    {

        $booking = customer_bookings::select('id', 'car_id', 'booking_id', 'customer_id', 'time_date', 'category_id', 'item_id')->where('customer_id',$request->customer_id)->first();
        
        

        if ($booking) {



            $cars = cars::select('model', 'model_year', 'mileage', 'cylinder', 'mileage')->find($booking->car_id);

            if ($cars) {

                $booking['car_details'] = $cars;



            } else {

                $booking['car_details'] = [];



            }



            $customer = User::select('id', 'name', 'email', 'mobile_number', 'gender', 'address')->find($booking->customer_id);

            $booking['customer_details'] = $customer;

            $categories = service_categories::find($booking->category_id);

            if ($categories) {

                $booking['service_name'] = $categories->category_name;

            } else {

                $booking['service_name'] = "";



            }



            $items = items::select('id', 'item', 'price', 'description')->whereIn('id', explode(",", $booking->item_id))->get();

            if ($items) {

                $booking['parts_detail'] = $items;

            } 
            
            else {

                $booking['parts_detail'] = [];



            }





            return response()->json(['code' => 1, 'message' => 'customer Details', 'data' => $booking]);

        }
        else {



            return response()->json(['code' => 0, 'message' => 'No data Found', 'data' => []]);



        }



    }





    public function AdminLogin(Request $request)

    {

        $email = $request->email;

        $password = $request->password;

        $device_token = $request->firebase_token;







        $user = User::where('email', request('email'))->where('role', '=', null)

            ->first();



        $store_token = array($user->device_token);

        array_push($store_token, $device_token);





        if ($user) {



            $user = User::find($user->id);

            // $user->device_token = $device_token;

            // check if device token already exists

            if (strpos($user->device_token, $device_token) !== false) {

                // echo "True";

            } else {

                // echo "False";

                $user->device_token = implode(",", $store_token);

            }



            $user->save();



            if (Hash::check(request('password'), $user->password)) {

                return response()->json(['code' => 1, 'message' => 'Login Successfully', 'data' => $user]);

            } else {

                return response()->json(['code' => 0, 'message' => 'Please enter correct details']);

            }

        } else {

            return response()->json(['code' => 0, 'message' => 'This creditional does not match']);



        }





    }

 public function AddGarageProfile(Request $request){
     $randomNumber = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);

     
     garages::create([
            "garage_id"=>$randomNumber,
            "garage_name"=>$request->name,
            "garage_profile"=>$request->garage_profile,
            "email"=>$request->email,
            "mobile_number"=>$request->mobile_no,
            "address"=>$request->address,
            "city"=>$request->city
         ]);
         
     
     
     return response()->json(['code' => 1, 'message' => 'New Garage Profile Added',"Darta"=>$randomNumber] );
 }



    public function GarageList(Request $request)

    {

        $garages = garages::get();

        foreach ($garages as $garage) {

            $bookings = customer_bookings::where('garage_id', $garage->id)->get();

            $garage['count_of_cars'] = $bookings->count();

        }

        return response()->json(['code' => 1, 'message' => 'Garage Listing', 'data' => $garages]);

    }





    public function GarageDetai(Request $request)

    {

        $garage_id = $request->garage_id;

        $garages = garages::find($garage_id);

        if ($garages) {

            $bookings = customer_bookings::select('car_id', 'garage_id', 'category_id', 'item_id', 'time_date')->where('garage_id', $garages->id)->get();

            foreach ($bookings as $booking) {

                $cars = cars::select('model', 'model_year', 'mileage', 'cylinder', 'mileage')->find($booking->car_id);

                if ($cars) {

                    $garages['car_details'] = $cars;

                } else {

                    $garages['car_details'] = [];



                }



                $categories = service_categories::find($booking->category_id);

                if ($categories) {

                    $garages['service_name'] = $categories->category_name;

                }

                $garages['date_time'] = $booking->time_date;

                $items = items::select('id', 'item', 'price', 'description')->whereIn('id', explode(",", $booking->item_id))->get();

                $garages['parts_details'] = $items;



            }

            return response()->json(['code' => 1, 'message' => 'Garage Details', 'data' => $garages]);

        } else {

            return response()->json(['code' => 1, 'message' => 'Id does not exists.', 'data' => []]);



        }



    }





    public function CustomerList(Request $request)

    {

        $status = $request->status;

        if ($status == "1") {

            $customers = customer_bookings::select('id', 'car_id', 'customer_id', 'status', 'booking_id')

                ->where('status', '=', '1')->orderBy('updated_at', 'desc')->get();

            foreach ($customers as $customer) {

                $car = cars::find($customer->car_id);

                if ($car) {

                    $customer['plate_number'] = $car->plate_number;

                    $customer['cars_under_customer'] = $car->model;



                }



                $users = User::find($customer->customer_id);

                if ($users) {

                    $customer['customer_name'] = $users->name;

                    $customer['mobile_number'] = $users->mobile_number;

                }



                $customer['grage_name'] = "";

            }

            return response()->json(['code' => 1, 'message' => 'Completed list', 'data' => $customers]);

        } elseif ($status == "2") {

            $customers = customer_bookings::select('id', 'car_id', 'customer_id', 'status', 'booking_id')->where('status', '=', '3')->orderBy('updated_at', 'desc')->get();

            foreach ($customers as $customer) {

                $car = cars::find($customer->car_id);

                if ($car) {

                    $customer['plate_number'] = $car->plate_number;

                    $customer['cars_under_customer'] = $car->model;



                }



                $users = User::find($customer->customer_id);

                if ($users) {

                    $customer['customer_name'] = $users->name;

                    $customer['mobile_number'] = $users->mobile_number;

                }



                $customer['grage_name'] = "";

            }

            return response()->json(['code' => 1, 'message' => 'Cancel list', 'data' => $customers]);

        } else {

            $customers = customer_bookings::select('id', 'car_id', 'customer_id', 'status', 'booking_id')

                ->where('status', '=', '0')->orderBy('updated_at', 'desc')->get();

            foreach ($customers as $customer) {

                $car = cars::find($customer->car_id);

                if ($car) {

                    $customer['plate_number'] = $car->plate_number;

                    $customer['cars_under_customer'] = $car->model;



                }



                $users = User::find($customer->customer_id);

                if ($users) {

                    $customer['customer_name'] = $users->name;

                    $customer['mobile_number'] = $users->mobile_number;

                }



                $customer['grage_name'] = "";

            }

            return response()->json(['code' => 1, 'message' => 'Pending list', 'data' => $customers]);

        }





    }

    public function SelectCar(Request $request)

    {

        $car_id = $request->car_id;



        $car_name = cars::select('model')->find($car_id);

        if ($car_name) {

            return response()->json(['code' => 1, 'message' => 'Selected car name', 'data' => $car_name]);

        } else {

            return response()->json(['code' => 1, 'message' => 'Selected car name', 'data' => []]);



        }



    }





    public function ConfirmBooking(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {

            $bookings->pickup_status = "1";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Customer";

            }



            // $firebaseToken = User::where('email','admin@gmail.com')->where('role','=',null)->pluck('device_token')->all();

            // $firebaseToken = User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

            $token_array = explode(',', $firebaseToken->device_token);



            $SERVER_API_KEY = 'Enter_Your_Server_Key';

            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Car Pickup Confirmation',

                    "body" => 'ready to give you a car confirmation by ' . $user_name,

                ]

            ];

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);



            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Car Pickup Confirmation';

            $notifications->message = 'ready to give you a car confirmation by ' . $user_name;

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Booking Confirm successfyully']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }



    public function PickupList(Request $request)

    {

        $bookings = customer_bookings::select('id', 'booking_id', 'car_id', 'customer_id', 'time_date')->where('pickup_status', '=', '1')->get();

        foreach ($bookings as $booking) {

            $cars = cars::select('id', 'brand_id')->find($booking->car_id);

            if ($cars) {

                $models = car_models::select('id', 'image', 'brand_id')->where('brand_id', $cars->brand_id)->first();



            }

            if ($models) {

                $booking['car_image'] = url('/storage/' . $models->image);

            } else {

                $booking['car_image'] = "";

            }



            $users = User::select('id', 'name')->find($booking->customer_id);

            if ($users) {

                $booking['customer_name'] = $users->name;

            } else {

                $booking['customer_name'] = "";

            }



            $garages = garages::select('id', 'garage_profile')->find($booking->garage_id);

            if ($garages) {

                $booking['garage_profile'] = $garages->garage_profile;

            } else {

                $booking['garage_profile'] = "";

            }

        }

        return response()->json(['code' => 1, 'message' => 'Pickup Schedule List', 'data' => $bookings]);



    }



    public function PickupListDetails(Request $request)

    {

        $booking = customer_bookings::select('id', 'car_id', 'booking_id', 'customer_id', 'time_date', 'category_id', 'item_id', 'garage_id', 'status')->find($request->pickup_id);

        if ($booking) {

            if ($booking->status == "4") {



                $cars = cars::select('model', 'model_year', 'mileage', 'cylinder', 'mileage')->find($booking->car_id);

                $booking['car_details'] = $cars;



                $garages = garages::find($booking->garage_id);

                if ($garages) {

                    $booking['garage_details'] = $garages;



                } else {

                    $booking['garage_details'] = $booking['garage_details'] = [

                        'id' => 1,

                        'garage_id' => '766767',

                        'garage_name' => 'Hamad Garage',

                        'garage_profile' => "Imachono Service",

                        'email' => 'garage@gmail.com',

                        'mobile_number' => '9712760068',

                        'address' => 'Varachha',

                        'city' => 'Surat'

                    ];





                }

                $users = User::select('id', 'name', 'email', 'address')->find($booking->customer_id);

                if ($users) {

                    $booking['pickup_details'] = $users;

                } else {

                    $booking['pickup_details'] = [];

                }



                return response()->json(['code' => 1, 'message' => 'Pickup Details', 'data' => $booking]);

            } else {

                return response()->json(['code' => 0, 'message' => 'No data Found', 'data' => []]);



            }

        } else {



            return response()->json(['code' => 0, 'message' => 'No data Found', 'data' => []]);



        }



    }



    public function PickupCondition(Request $request)

    {

        // if($request->hasFile('car_image')){

        // return response()->json(['code'=> 1,'message'=>'Data from api.','data'=> [$request->all(),$_FILES['images'], $request->file('images')[1]->getClientOriginalName(), $request->car_condition]]);

        // }else{

        //     return response()->json(['code'=> 1,'message'=>'Files not exists.','data'=> [$request]]);

        // }







        $customer_bookings = customer_bookings::select(

            'id',

            'job_number',

            'booking_id'

        )

            ->where('booking_id', $request->booking_id)->first();

        if ($customer_bookings) {



            $pickup = new pickup_conditions;

            $pickup->car_image = "";

            $pickup->label = $request->label;

            if ($request->hasFile('images')) {

                $count = count($request->file('images'));

                for ($i = 0; $i < $count; $i++) {

                    $fileNameExt = $request->file('images')[$i]->getClientOriginalName();

                    $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

                    $fileExt = $request->file('images')[$i]->getClientOriginalExtension();

                    $fileNameToStore = $fileName . '_' . time() . '.' . $fileExt;

                    $pathToStore = $request->file('images')[$i]->storeAs('public', $fileNameToStore);

                    $pickup->car_image = $pickup->car_image . "" . $fileNameToStore . ",";

                }

            }

            $pickup->car_conditions = $request->car_condition;

            $pickup->work_needed = $request->work_needed;

            $pickup->booking_id = $request->booking_id;



            $pickup->save();





            return response()->json(['code' => 1, 'message' => 'Pickup request', 'data' => $pickup]);

        } else {

            return response()->json(['code' => 0, 'message' => 'Booking does not exists.', 'data' => []]);



        }

    }



    public function PickupConditionList(Request $request)

    {

        // dd("test");

        $booking_id = $request->booking_id;

        // return response()->json(['code'=> '1','message'=>'pickup condition List','data'=>'test']);

        $conditions = pickup_conditions::where('booking_id', $booking_id)->orderBy('created_at', 'desc')->get();

        return response()->json(['code' => '1', 'message' => 'pickup condition List', 'data' => $conditions]);

    }



    // Old 

    //  public function PickupCondition(Request $request)

    // {



    //     $customer_bookings = customer_bookings::select('id','job_number',

    //     'booking_id')

    //     ->where('booking_id',$request->booking_id)->first();

    //     if($customer_bookings){

    //         $pickup = new job_cards;

    //         $pickup->label = $request->label;

    //         if($request->hasFile('car_image'))

    //         {

    //             $fileNameExt = $request->file('car_image')->getClientOriginalName();

    //             $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

    //             $fileExt = $request->file('car_image')->getClientOriginalExtension();

    //             $fileNameToStore = $fileName.'_'.time().'.'.$fileExt;

    //             $pathToStore = $request->file('car_image')->storeAs('public',$fileNameToStore);

    //             $pickup->car_imagge = $fileNameToStore;

    //         }

    //         $pickup->car_condition = $request->car_condition;

    //         $pickup->work_needed = $request->work_needed;

    //         $pickup->booking_id = $request->booking_id;

    //         if($customer_bookings->job_number!= null){

    //             $pickup->job_number = $customer_bookings->job_number;

    //         }else{

    //             $job_number = random_int(100000, 999999);

    //             $pickup->job_number = $job_number;

    //         }

    //         $pickup->save();

    //         $customer_bookings->job_number = $pickup->job_number;

    //         $customer_bookings->save();



    //         return response()->json(['code'=> 1,'message'=>'Pickup request','data'=> $pickup]);

    //     }else{

    //         return response()->json(['code'=> 1,'message'=>'Booking does not exists.','data'=> []]);



    //     }

    // }

    public function ShowPickupParts(Request $request)

    {

        $job_cards = job_cards::select('id', 'car_imagge', 'car_condition', 'work_needed', 'booking_id', 'job_number', 'booking_id')->where('job_number', $request->job_number)->get();

        foreach ($job_cards as $job_card) {

            $customer_bookings = customer_bookings::select(

                'id',

                'job_number',

                'customer_id',

                'car_id',

                'booking_id'

            )

                ->where('booking_id', $job_card->booking_id)->first();

            if ($customer_bookings) {

                $users = User::select('name', 'mobile_number')->find($customer_bookings->customer_id);

                $cars = cars::select('model', 'model_year', 'mileage')->find($customer_bookings->car_id);

            } else {

                $users = [];

                $cars = [];



            }

            $job_card['car_imagge'] = url('storage/' . $job_card->car_imagge);

            $job_card['customer_details'] = $users;

            $job_card['car_details'] = $cars;

        }

        return response()->json(['code' => 1, 'message' => 'Job Card Details', 'data' => $job_cards]);



    }



    public function UpdateJobCard(Request $request)

    {

        $bookings = job_cards::where('job_number', $request->job_number)->orderBy('updated_at', 'desc')->get();
        
        

        $bookings->job_date = $request->job_date;
        $bookings->date_time = $request->date_time;


        foreach ($bookings as $key => $booking) {

            $ids[] = $booking->id;

            $booking_update = job_cards::whereIn('id', $ids)->update($request->all());

            $booking['car_imagge'] = url('storage/' . $booking->car_imagge);

            $customer_bookings = customer_bookings::select(

                'id',

                'job_number',

                'booking_id'

            )

                ->where('booking_id', $booking->booking_id)->first();

            if ($customer_bookings != null) {

                $customer_bookings->garage_id = $booking->garage_id;

                $customer_bookings->save();

            }

        }

        $booking_id = $request->booking_id;

        $bookings = customer_bookings::select('id', 'booking_id', 'customer_id')->where('booking_id', $booking_id)->first();



        $user = User::find($bookings->customer_id);

        if ($user) {

            $user_name = $user->name;

        } else {

            $user_name = "Admin";

        }

        $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



        $token_array = explode(',', $firebaseToken->device_token);

        $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';
        
         if(User::select('locale')->where('email', $user->email)->where('role', '!=', null)->first()['locale']=='en'){
              $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",

                "status" => "Job Card",

                "screen" => "screenA",

            ],

            "notification" => [

                "title" => 'Job Card uploaded',

                "body" => 'Job Card uploaded by iMechano',

            ]

        ];
             
         }
         else{
              $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",

                "status" => "Job Card",

                "screen" => "screenA",

            ],

            "notification" => [

                "title" => '   ',

                "body" => '     iMechano',

            ]

        ];
             
             
             
             
             
         }

      

        $dataString = json_encode($data);

        $headers = [

            'Authorization: key=' . $SERVER_API_KEY,

            'Content-Type: application/json',

        ];

        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

        curl_setopt($ch, CURLOPT_POST, true);

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

        $response = curl_exec($ch);





        $notifications = new Notifications;

        $notifications->car_id = $bookings->car_id;

        $notifications->customer_id = $bookings->customer_id;

        $notifications->admin_id = "0";

        $notifications->title = 'Job Card uploded';

        $notifications->message = 'Job Card uploded by iMechano';

        $notifications->save();







        return response()->json(['code' => 1, 'message' => 'Job Card Created!']);

        // }else{

        //   return response()->json(['code'=>0,'message'=>'job id  does not exist','data'=>[]]);



        // }





    }

//Approveddddd

    // public function ApproveJobCard(Request $request)

    // {

    //     // $card = job_cards::where('job_number',$request->job_number)->get();
    //     // $card = job_cards::where('job_number',$request->job_number)->first();

    //     // if($card){

    //     // $card->status = "3";

    //     // $card->save;
        
    //     $job_cards_status = job_cards::select('status')->where('job_number', $request->job_number)->get()->unique('job_number');

    //     if($job_cards_status=="0"){
            
    //         job_cards::where('job_number', $request->job_number)

    //         ->update([

    //             'status' => "3"

    //         ]);
    //     }
        
    //     else if($job_cards_status=="3"){
            
    //          job_cards::where('job_number', $request->job_number)

    //         ->update([

    //             'status' => "1"

    //         ]);
    //     }
        


        



    //     $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

    //     // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

    //     $token_array = explode(',', $firebaseToken->device_token);

    //     $SERVER_API_KEY = 'Enter_Your_Server_Key';



    //     $data = [

    //         "registration_ids" => $token_array,

    //         "data" => [

    //             "click_action" => "FLUTTER_NOTIFICATION_CLICK",

    //             "sound" => "default",

    //             "status" => "Job Card",

    //             "screen" => "screenA",

    //         ],

    //         "notification" => [

    //             "title" => 'Approve Job Card',

    //             "body" => 'User has Approve a Job Card',

    //         ]

    //     ];

    //     $dataString = json_encode($data);



    //     $headers = [

    //         'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

    //         'Content-Type: application/json',

    //     ];



    //     $ch = curl_init();



    //     curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

    //     curl_setopt($ch, CURLOPT_POST, true);

    //     curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    //     curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

    //     curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

    //     curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    //     curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



    //     $response = curl_exec($ch);





    //     $notifications = new Notifications;

    //     $notifications->message = 'User has Approve a Job Card';

    //     $notifications->save();

    //     return response()->json(['code' => 1, 'message' => 'Job card Approved']);

    //     // }else{



    //     //     return response()->json(['code'=> 0,'message'=>'This Job doesnot exists']);



    //     // }     





    // }
    
    public function Reports(){
        
        $customer_count = DB::table('users')
    ->select(DB::raw('COUNT(DISTINCT email) as count'))
    ->groupBy('email')
    ->get()
    ->count();
    
$today = now()->toDateString(); 


    $total_customer_pending = DB::table('customer_bookings')->whereNotNull('customer_bookings.garage_id')
    ->join('cars', 'customer_bookings.car_id', '=', 'cars.id')
    ->join('car_brands','cars.brand_id','=','car_brands.id')->select('car_brands.brand')
    ->join('users', 'customer_bookings.customer_id', '=', 'users.id')->join('garages', 'customer_bookings.garage_id', '=', 'garages.garage_id')->join('job_cards','customer_bookings.booking_id','job_cards.booking_id')->where('job_cards.status','!=','3')->select('plate_number','customer_id','garage_name','model','name','brand')
    ->get();
    //Total Customers 
    
    $total_customer_complete = DB::table('customer_bookings')->whereNotNull('customer_bookings.garage_id')
    ->join('cars', 'customer_bookings.car_id', '=', 'cars.id')
    ->join('car_brands','cars.brand_id','=','car_brands.id')->select('car_brands.brand')
    ->join('users', 'customer_bookings.customer_id', '=', 'users.id')->join('garages', 'customer_bookings.garage_id', '=', 'garages.garage_id')->join('job_cards','customer_bookings.booking_id','job_cards.booking_id')->where('job_cards.status','3')->select('plate_number','customer_id','garage_name','model','name','brand')
    ->get();
    
    /////
   
    $average_ticket= DB::table('customer_bookings')->whereNotNull('customer_bookings.garage_id')->whereDate('customer_bookings.created_at',$today)
    ->join('cars', 'customer_bookings.car_id', '=', 'cars.id')
    ->join('car_brands','cars.brand_id','=','car_brands.id')->select('car_brands.brand')
    ->join('users', 'customer_bookings.customer_id', '=', 'users.id')->join('garages', 'customer_bookings.garage_id', '=', 'garages.garage_id')->select('customer_bookings.created_at','customer_bookings.booking_id','garage_name','customer_id')
    ->get();
    
    
    $conversion_detail=DB::table('job_cards')->where('status','1')
    ->join('garages', 'job_cards.garage_id', '=', 'garages.garage_id')->select('job_cards.created_at','booking_id','garage_name','customer_name','car_reg_number')
    ->get();
    
    $workshop=DB::table('customer_bookings')->whereNotNull('customer_bookings.garage_id')
    ->join('cars', 'customer_bookings.car_id', '=', 'cars.id')
    ->join('car_brands','cars.brand_id','=','car_brands.id')->select('car_brands.brand')
    ->join('users', 'customer_bookings.customer_id', '=', 'users.id')->join('garages', 'customer_bookings.garage_id', '=', 'garages.garage_id')->select('customer_bookings.created_at','customer_id','garage_name','customer_bookings.booking_id')
    ->get();
    
    $workprogess= DB::table('job_cards')
    ->join('garages', 'job_cards.garage_id', '=', 'garages.garage_id')->select('job_cards.id','job_cards.created_at','booking_id','garage_name','customer_name','car_reg_number')
    ->get();
    
    $ready_delivery_pending=DB::table('job_cards')->where('delivery_request','1')
    ->join('garages', 'job_cards.garage_id', '=', 'garages.garage_id')->select('job_cards.created_at','booking_id','garage_name','customer_name','car_reg_number')
    ->get();
    
   
    $ready_delivery_complete=DB::table('job_cards')->where('delivery_request','2')
    ->join('garages', 'job_cards.garage_id', '=', 'garages.garage_id')->select('job_cards.created_at','booking_id','garage_name','customer_name','car_reg_number')
    ->get();
    
    $today_booking=DB::table('customer_bookings')->whereDate('customer_bookings.created_at',$today)
    ->select('customer_bookings.created_at','customer_bookings.booking_id','customer_id')
    ->get();
    
    $activeCustomers= DB::table('customer_bookings')
    ->select(DB::raw('DISTINCT customer_id'))
    ->groupBy('customer_id')
    ->get();
    
    
    $averageTicket = DB::table('customer_bookings')
    ->where('admin_status', 2)
    ->select(DB::raw('AVG(CAST(total AS DECIMAL(10,2)) + CAST(delievery_charges AS DECIMAL(10,2))) AS average'))
    ->value('average');

  
  $averageTicket=number_format($averageTicket, 2, '.', '');
  
  $gvm= DB::table('customer_parts')->sum('total');
  
  $openOrder= DB::table('customer_bookings')
    ->where('admin_status', 2)
    ->where('payment_status', 1)
    ->count();
    
    $atWorkShop= DB::table('customer_bookings')
    ->where('delivery_status', 1)
    ->count();
    
    $readyForDelivery=DB::table('job_cards')
    ->where('delivery_request', 2)
    ->count();
    
    $conversions= strval(round( (DB::table('customer_bookings')
    ->where('payment_status', 1)
    ->count()/DB::table('customer_bookings')->count())*100,2));
    
    $todayCount=  DB::table('customer_bookings')
    ->whereRaw('DATE(created_at) = CURDATE()')
    ->count();
    
    $reports['customer_count']=$customer_count;
    $reports['conversions']=$conversions;
    $reports['todayCount']=$todayCount;
    $reports['averageTicketSize']=$averageTicket;
    $reports['gvm']=$gvm;
    $reports['open_orders']=$openOrder;
    $reports['atWorkShop']=$atWorkShop;
    $reports['readyForDelivery']=$readyForDelivery;
    $reports['total_customer']=$total_customer_pending;
    $reports['total_customer_complete']=$total_customer_complete;
    $reports['average_ticket']=$average_ticket;
    $reports['conversion_detail']=$conversion_detail;
    $reports['workshop']=$workshop;
    $reports['workprogess']=$workprogess;
    $reports['ready_delivery_pending']=$ready_delivery_pending;
    $reports['ready_delivery_complete']=$ready_delivery_complete;
    $reports['today_booking']=$today_booking;
    
    
    
    
        return response()->json(['code'=> 0,'message'=>"Reports", "reports"=>$reports]);
        
    }
    
    
     public function ApproveJobCard(Request $request)

    {

        // $card = job_cards::where('job_number',$request->job_number)->get();



        $card = job_cards::where('job_number',$request->job_number)->first();
    $booking=customer_bookings::where('booking_id',$card->booking_id)->first();
    
    

        // if($card){

        // $card->status = "3";

        // $card->save;

        
        if ($card->status==0){
            
           job_cards::where('job_number', $request->job_number)

            ->update([

                'status' => "3"
            ]); 
            
        }
        else if($card->status==3){
             job_cards::where('job_number', $request->job_number)

            ->update([

                'status' => "1"
            ]); 
            
                 $booking->delivery_status=2;
                $booking->save();
        }

        



        $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

        // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

        $token_array = explode(',', $firebaseToken->device_token);

        $SERVER_API_KEY = 'Enter_Your_Server_Key';

if($card->status==3){
            $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",
                
                "job_number"=> $request->job_number,

                "status" => "Confirm Delivery Completed",

                "screen" => "screenA",

            ],
            

            "notification" => [

                "title" => 'Confirm Delivery Completed',

                "body" => 'User has confirmed the delivery',

            ]

        ];

}
else{
     $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",
                
                "job_number"=> $request->job_number,

                "status" => "Approve Job Card",

                "screen" => "screenA",

            ],
            

            "notification" => [

                "title" => 'Approve Job Card',

                "body" => 'User has Approve a Job Card',

            ]

        ];
}


        $dataString = json_encode($data);



        $headers = [

            'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

            'Content-Type: application/json',

        ];



        $ch = curl_init();



        curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

        curl_setopt($ch, CURLOPT_POST, true);

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



        $response = curl_exec($ch);





        $notifications = new Notifications;
        
 $notifications->title='Approve Job Card';
 $notifications->admin_id="1";
        $notifications->message = 'User has Approve a Job Card';

        $notifications->save();

        return response()->json(['code' => 1, 'message' => 'Job card Approved']);

        // }else{



        //     return response()->json(['code'=> 0,'message'=>'This Job doesnot exists']);



        // }     





    }



    public function CancelJobCard(Request $request)

    {

        // $card = job_cards::where('job_number',$request->job_number)->get();



        // $card = job_cards::where('job_number',$request->job_number)->first();

        // if($card){

        // $card->status = "2";

        // $card->save;



        job_cards::where('job_number', $request->job_number)

            ->update([

                'status' => "2"

            ]);



        $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

        // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

        $token_array = explode(',', $firebaseToken->device_token);

        $SERVER_API_KEY = 'Enter_Your_Server_Key';



        $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",

                "status" => "Job Card",

                "screen" => "screenA",

            ],

            "notification" => [

                "title" => 'Cancel Job Card',

                "body" => 'User has cancel a Job Card',

            ]

        ];

        $dataString = json_encode($data);



        $headers = [

            'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

            'Content-Type: application/json',

        ];



        $ch = curl_init();



        curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

        curl_setopt($ch, CURLOPT_POST, true);

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



        $response = curl_exec($ch);





        $notifications = new Notifications;

        $notifications->message = 'User has cancel a Job Card';

        $notifications->save();

        return response()->json(['code' => 1, 'message' => 'Job card Cancelled']);

        // }else{



        //     return response()->json(['code'=> 0,'message'=>'This Job doesnot exists']);



        // }     





    }



    public function AppoiementDetail(Request $request)

    {

        $booking = customer_bookings::select('id', 'car_id', 'booking_id', 'customer_id', 'time_date', 'delivery_time', 'category_id', 'item_id', 'garage_id')->find($request->appoiement_id);

        if ($booking) {



            $cars = cars::select('model', 'model_year', 'mileage', 'cylinder', 'mileage')->find($booking->car_id);

            if ($cars) {

                $booking['car_details'] = $cars;

            } else {

                $booking['car_details'] = [];

            }



            $garages = garages::where('garage_id', $booking->garage_id)->first();



            if ($garages) {

                $booking['garage_details'] = $garages;



            } else {





                $booking['garage_details'] = [

                    'id' => 1,

                    'garage_id' => '766767',

                    'garage_name' => 'Hamad Garage',

                    'garage_profile' => "Imachono Service",

                    'email' => 'garage@gmail.com',

                    'mobile_number' => '9712760068',

                    'address' => 'Varachha',

                    'city' => 'Surat',

                    'test' => $garages

                ];



            }

            $users = User::select('id', 'name', 'email', 'address')->find($booking->customer_id);

            $booking['pickup_details'] = $users;



            return response()->json(['code' => 1, 'message' => 'Appoinments Details', 'data' => $booking]);

        } else {



            return response()->json(['code' => 0, 'message' => 'No data Found', 'data' => []]);



        }



    }



    public function pickuprequest(Request $request)

    {

        $booking_id = $request->booking_id;

        $booking = customer_bookings::select('id', 'booking_id', 'customer_id')->where('booking_id', $booking_id)->first();

        if ($booking) {

            $users = User::find($booking->customer_id);



            $firebaseToken = User::where('email', $users->email)->where('role', '!=', null)->pluck('device_token')->all();



            $SERVER_API_KEY = 'Enter_Your_Server_Key';



            $data = [

                "registration_ids" => $firebaseToken,

                "notification" => [

                    "title" => 'Car Pickup Request',

                    "body" => 'Be ready for pickup your car?

                    please give confirmation.',

                ]

            ];

            $dataString = json_encode($data);



            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];







            $ch = curl_init();



            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);



            $notifications = new Notifications;

            $notifications->car_id = $booking->car_id;

            $notifications->customer_id = $booking->customer_id;

            $notifications->admin_id = "0";

            $notifications->title = 'Car Pickup Request';

            $notifications->message = 'Be ready for pickup your car?

                    please give confirmation.';

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Pickup request send successfilly']);



        } else {

            return response()->json(['code' => 1, 'message' => 'Booking does not exists']);



        }

    }



    public function JobList(Request $request)

    {
        
        if($request->garageId!=""){
             $job_cards = job_cards::select('id', 'job_number', 'customer_name', 'customer_contact_no', 'garage_id','booking_id','created_at')->where('garage_id',$request->garageId)->orderBy('updated_at', 'desc')->get()->unique('job_number')->values();
        }
        else{
             $job_cards = job_cards::select('id', 'job_number', 'customer_name', 'customer_contact_no', 'garage_id','booking_id','created_at')->orderBy('updated_at', 'desc')->get()->unique('job_number')->values();
        }

       

        foreach ($job_cards as $job_card) {

            $garages = garages::find($job_card->garage_id);

            if ($garages) {

                $job_card['garage_profile'] = $garages->garage_profile;
                    
                $job_card->created_at=DateTime($job_card->created_at)->format('Y-m-d H:i:s');


            } else {

                $job_card['garage_profile'] = "";



            }

        }

        return response()->json(['code' => $request->garageId, 'message' => 'Job List', 'data' => $job_cards]);



    }

// Shoaib Added 



    public function CustomerJobList(Request $request)
    {
        

 $job_cards = job_cards::select('id','status','updated_at','booking_id', 'job_number', 'job_date', 'booking_id', 'customer_name', 'customer_contact_no', 'car_reg_number', 'year', 'mileage', 'date_time', 'delivery_time', 'car_make', 'car_model', 'vin_number','garage_id')->where('job_number', $request->job_number)->get()->unique('job_number');
 
 
 if($job_cards[0]->garage_id!=""){
     
      $job_cards = job_cards::join('garages','job_cards.garage_id','garages.garage_id')->select('job_cards.id','garages.garage_name','status','job_cards.updated_at','booking_id', 'job_number', 'job_date', 'booking_id', 'customer_name', 'customer_contact_no', 'car_reg_number', 'year', 'mileage', 'date_time', 'delivery_time', 'car_make', 'car_model', 'vin_number','job_cards.garage_id')->where('job_number', $request->job_number)->get()->unique('job_number');
     
 }
   
        

        foreach ($job_cards as $job_card) {
$garages = garages::find($job_card->garage_id);

            if ($garages) {

                $job_card['garage_profile'] = $garages->garage_profile;
                    
                $job_card->created_at=DateTime($job_card->created_at)->format('Y-m-d H:i:s');


            } else {

                $job_card['garage_profile'] = "";



            }
            $customer_bookings = customer_bookings::select(

                'id',

                'job_number',

                'customer_id',

                'car_id',

                'sub_category_id',

                'item_id',

                'booking_id',

                'total'

            )

                ->where('booking_id', $job_card->booking_id)->first();

            if ($customer_bookings) {

                $job_card['total'] = $customer_bookings->total;



                $subcategories = service_subcategories::find($customer_bookings->sub_category_id);

                if ($subcategories) {

                    $job_card['subcategory_name'] = $subcategories->name;



                } else {

                    $job_card['subcategory_name'] = "";

                }

                $parts = customer_parts::select('job_number', 'part_number', 'part_type', 'qty', 'est_cost', 'total')->where('job_number', $request->job_number)->get();

                $job_card['customer_parts'] = $parts;



                $customer_services = customer_services::select('job_number', 'service_desc', 'service_cost')->where('job_number', $request->job_number)->get();

                $job_card['customer_services'] = $customer_services;





            } else {

                $job_card['total'] = "";

                $job_card['subcategory_name'] = "";

                $job_card['customer_parts'] = [];

                $job_card['customer_services'] = [];







            }







        }

        return response()->json(['code' => 1, 'message' => 'Job Card Details', 'data' => $job_cards]);



    }



    public function JobCardsList(Request $request)

    {
        
        $customer_name=User::select('name')->find($request->customer_id);


        $job_cards_query = job_cards::select('id', 'booking_id', 'job_number', 'job_date', 'booking_id', 'customer_name', 'customer_contact_no', 'car_reg_number', 'year', 'mileage', 'date_time', 'car_make', 'car_model', 'vin_number', 'created_at','status')

            ->where('status', $request->status)->where('customer_name', $customer_name->name);
            
        



        if (strlen($request->search) > 2) {

            $job_cards_query = $job_cards_query->where('booking_id', 'LIKE', '%' . $request->search . '%');

        }



        if (strlen($request->end_date) > 2) {



            $start_date = Carbon::parse($request->start_date)->format('Y-m-d 00:00:00');

                $end_date = Carbon::parse($request->end_date)->format('Y-m-d 23:59:59');
                
                 if ($start_date === $end_date) {
                      $job_cards_query = $job_cards_query->whereDate('created_at',$start_date);
                     
                 }
                 else{
                     
                       $job_cards_query = $job_cards_query->whereBetween('created_at', [

                $start_date,

                $end_date

            ]);
                 }
                 

          



        }



        $job_cards_query = $job_cards_query->orderBy('id', 'DESC')->get();





        return response()->json(['code' => 1, 'message' => 'Job Card Details', 'data' => $job_cards_query]);



    }



    // public function JobCardsList(Request $request)

    // {

    //     if($request->status == "3"){

    //            $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status','=',"0")->where('admin_status','=',"1")

    //           ->orderBy('updated_at', 'desc')->get();

    //           if(strlen($request->end_date) > 2){

    //               $start_date = Carbon::parse($request->start_date)->toDateTimeString();

    //             $end_date = Carbon::parse($request->end_date)->toDateTimeString();



    //             $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status','=',"0")->where('admin_status','=',"1")->

    //             whereBetween('created_at', [

    //              $start_date, $end_date

    //             ])->get();

    //           }

    //         foreach($job_cards as $booking){

    //         $subcategories = service_subcategories::find($booking->sub_category_id);

    //         if(strlen($request->search) > 1){



    //             // Search sub Category

    //             if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

    //                  $booking['subcategory_name'] = $subcategories->name;

    //                  $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                 $booking['items'] = $items;

    //             }



    //             //Search by Car Number

    //             $cars = cars::find((int)$booking->car_id);

    //             if($cars)

    //                 if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

    //                      $booking['subcategory_name'] = $subcategories->name;

    //                      $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                      $booking['items'] = $items;

    //                     $booking['cars'] = $cars;

    //                 }



    //         }else{



    //             $booking['subcategory_name'] = $subcategories->name;

    //             $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //             $booking['items'] = $items;

    //         }

    //         }

    //     }else if($request->status == "0"){



    //            $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status',$request->status)

    //            ->where('admin_status','=',"0")->orderBy('updated_at', 'desc')->get();



    //            if(strlen($request->end_date) > 2){

    //               $start_date = Carbon::parse($request->start_date)->toDateTimeString();

    //               $end_date = Carbon::parse($request->end_date)->toDateTimeString();



    //             $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status',$request->status)

    //            ->where('admin_status','=',"0")->

    //             whereBetween('created_at', [

    //              $start_date, $end_date

    //             ])->get();

    //           }



    //         foreach($job_cards as $booking){

    //         $subcategories = service_subcategories::find($booking->sub_category_id);





    //         if(strlen($request->search) > 1){

    //             // Search sub Category

    //             if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

    //                  $booking['subcategory_name'] = $subcategories->name;

    //                  $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                 $booking['items'] = $items;

    //             }



    //             //Search by Car Number

    //             $cars = cars::find((int)$booking->car_id);

    //             if($cars)

    //                 if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

    //                      $booking['subcategory_name'] = $subcategories->name;

    //                      $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                      $booking['items'] = $items;

    //                     $booking['cars'] = $cars;

    //                 }





    //         }else{

    //             $booking['subcategory_name'] = $subcategories->name;

    //             $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //             $booking['items'] = $items;

    //         }

    //         }

    //     }else if($request->status == "1"){



    //            $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status',$request->status)

    //            ->where('admin_status','=',"1")->where('payment_status','=',"1")->orderBy('updated_at', 'desc')->get();



    //            if(strlen($request->end_date) > 2){

    //               $start_date = Carbon::parse($request->start_date)->toDateTimeString();

    //               $end_date = Carbon::parse($request->end_date)->toDateTimeString();



    //             $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status',$request->status)

    //            ->where('admin_status','=',"1")->where('payment_status','=',"1")->

    //             whereBetween('created_at', [

    //              $start_date, $end_date

    //             ])->get();

    //           }



    //         foreach($job_cards as $booking){

    //         $subcategories = service_subcategories::find($booking->sub_category_id);

    //         if(strlen($request->search) > 1){

    //             // Search sub Category

    //             if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

    //                  $booking['subcategory_name'] = $subcategories->name;

    //                  $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                 $booking['items'] = $items;

    //             }



    //             //Search by Car Number

    //             $cars = cars::find((int)$booking->car_id);

    //             if($cars)

    //                 if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

    //                      $booking['subcategory_name'] = $subcategories->name;

    //                      $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                      $booking['items'] = $items;

    //                     $booking['cars'] = $cars;

    //                 }





    //         }else{

    //             $booking['subcategory_name'] = $subcategories->name;

    //             $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //             $booking['items'] = $items;

    //         }

    //         }

    //     }else if($request->status == "2"){



    //            $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status',$request->status)

    //           ->orderBy('updated_at', 'desc')->get();



    //           if(strlen($request->end_date) > 2){

    //               $start_date = Carbon::parse($request->start_date)->toDateTimeString();

    //               $end_date = Carbon::parse($request->end_date)->toDateTimeString();



    //             $job_cards = job_cards::where('customer_id',$request->customer_id)->where('status',$request->status)->

    //             whereBetween('created_at', [

    //              $start_date, $end_date

    //             ])->get();

    //           }



    //         foreach($job_cards as $booking){

    //         $subcategories = service_subcategories::find($booking->sub_category_id);

    //         if(strlen($request->search) > 1){

    //             // Search sub Category

    //             if (strpos(strtolower($subcategories->name), strtolower($request->search)) !== false) {

    //                  $booking['subcategory_name'] = $subcategories->name;

    //                  $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                 $booking['items'] = $items;

    //             }



    //             //Search by Car Number

    //             $cars = cars::find((int)$booking->car_id);

    //             if($cars)

    //                 if (strpos(strtolower($cars->plate_number), strtolower($request->search)) !== false || strpos(strtolower($cars->model), strtolower($request->search)) !== false) {

    //                      $booking['subcategory_name'] = $subcategories->name;

    //                      $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //                      $booking['items'] = $items;

    //                     $booking['cars'] = $cars;

    //                 }





    //         }else{

    //             $booking['subcategory_name'] = $subcategories->name;

    //             $items = items::whereIn('id',explode(",",$booking->item_id))->get();

    //             $booking['items'] = $items;

    //         }

    //         }

    //     }

    //     // dd($bookiing['items']);

    //     // if($booking['items'] == null) 

    //     // $bookings = "{}";



    //     return response()->json(['code'=> 1,'message'=>'Job Card Details','data'=>$job_cards]);



    // }





    public function CustomerJobs(Request $request)

    {

        $job_card_lists = job_cards::select('id', 'booking_id', 'garage_id', 'job_number', 'job_date', 'booking_id', 'customer_name', 'customer_contact_no', 'car_reg_number', 'year', 'mileage', 'date_time', 'car_make', 'car_model', 'vin_number')

            ->where('booking_id', $request->booking_id)->get();



        foreach ($job_card_lists as $job_card_list) {

            $garages = garages::select('id', 'garage_profile')->find($job_card_list->garage_id);

            if ($garages) {

                $job_card_list['garage_profile'] = $garages->garage_profile;

            } else {

                $job_card_list['garage_profile'] = "";

            }

        }





        return response()->json(['code' => 1, 'message' => 'Job Card Lists', 'data' => $job_card_lists]);



    }





    public function SendAdmin(Request $request)

    {



        $title = $request->title;

        $message = $request->message;



        $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

        // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

        $token_array = explode(',', $firebaseToken->device_token);

        $SERVER_API_KEY = 'Enter_Your_Server_Key';



        $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",

                "status" => "Job Card",

                "screen" => "screenA",

            ],

            "notification" => [

                "title" => $title,

                "body" => $message,

            ]

        ];

        $dataString = json_encode($data);



        $headers = [

            'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

            'Content-Type: application/json',

        ];



        $ch = curl_init();



        curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

        curl_setopt($ch, CURLOPT_POST, true);

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



        $response = curl_exec($ch);





        $notifications = new Notifications;

        $notifications->message = $message;

        $notifications->save();







        return response()->json(['code' => 1, 'message' => 'Send notification to admin']);







    }



    public function SendCustomer(Request $request)

    {



        $title = $request->title;

        $message = $request->message;

        $booking = customer_bookings::select('id', 'delivery_status', 'customer_id', 'garage_id')->where('booking_id', $request->booking_id)->first();

        $booking->delivery_status = 1;

        $booking->save();

        $user = User::find($booking->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "User";

            }





            $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();

        $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';



        $token_array = explode(',', $firebaseToken->device_token);

        $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",

                "status" => "Please Confirm Delivery",

                "screen" => "screenA",

            ],

            "notification" => [

                "title" => $title,

                "body" => $message,

            ]

        ];

        $dataString = json_encode($data);



        $headers = [

            'Authorization: key=' . $SERVER_API_KEY,

            'Content-Type: application/json',

        ];







        $ch = curl_init();



        curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

        curl_setopt($ch, CURLOPT_POST, true);

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



        $response = curl_exec($ch);



        return response()->json(['code' => 1, 'message' => $booking->customer_id.' Send notification to customer '.$firebaseToken]);





    }



    //27-2-2022



    public function IncomingBookings(Request $request)

    {

      
        $from_date = "";

        $to_date = "";

        $status = $request->status;

        if ($from_date && $to_date) {

            if ($from_date == $to_date) {

                $bookings = customer_bookings::select('id', 'booking_id', 'customer_id', 'garage_id', 'time_date','created_at')->whereDate('time_date', date('Y-m-d'))->where('admin_status', $status)->get();



            } else {

                $bookings = customer_bookings::select('id', 'booking_id', 'customer_id', 'garage_id', 'time_date','created_at','car_id')->whereBetween('time_date', [$from_date, $to_date])->where('admin_status', $status)->get();



            }



            foreach ($bookings as $booking) {

                $cars = cars::select('id', 'brand_id')->find($booking->car_id);
                

                if ($cars) {

                    $models = car_models::select('id', 'image', 'brand_id')->where('brand_id', $cars->brand_id)->first();



                    if ($models) {

                        $booking['car_image'] = url('/storage/' . $models->image);

                    } else {

                        $booking['car_image'] = "";

                    }

                } else {

                    $booking['car_image'] = "";



                }



                $users = User::select('id', 'name')->find($booking->customer_id);

                if ($users) {

                    $booking['customer_name'] = $users->name;

                } else {

                    $booking['customer_name'] = "";

                }



                $garages = garages::select('id', 'garage_profile')->find($booking->garage_id);

                if ($garages) {

                    $booking['garage_profile'] = $garages->garage_profile;

                } else {

                    $booking['garage_profile'] = "";

                }



            }

        } else {

            $bookings = customer_bookings::select('id', 'booking_id', 'customer_id', 'garage_id', 'time_date','car_id','created_at')->where('admin_status', $status)->get();

            foreach ($bookings as $booking) {

                $cars = cars::select('model', 'brand_id')->find($booking->car_id);

                if ($cars) {

                    $models = car_models::select('id', 'image', 'brand_id')->where('model', $cars->model)->first();



                    if ($models) {

                        $booking['car_image'] = url('/storage/' . $models->image);

                    } else {

                        $booking['car_image'] = "";

                    }

                } else {

                    $booking['car_image'] = "";



                }



                $users = User::select('id', 'name')->find($booking->customer_id);

                if ($users) {

                    $booking['customer_name'] = $users->name;

                } else {

                    $booking['customer_name'] = "";

                }



                $garages = garages::select('id', 'garage_profile')->find($booking->garage_id);

                if ($garages) {

                    $booking['garage_profile'] = $garages->garage_profile;

                } else {

                    $booking['garage_profile'] = "";

                }



            }

        }

        

        return response()->json(['code' => 1, 'message' => 'Booking List', 'data' => $bookings]);



    }



    public function IncomingBookingsDetails(Request $request)

    {

        $id = $request->id;

        $booking = customer_bookings::select('id', 'car_id', 'booking_id', 'customer_id', 'delivery_status', 'time_date', 'category_id', 'item_id', 'garage_id')->find($request->id);

        if ($booking) {

            $garage_id = $booking->garage_id;

            if ($garage_id != null) {

                $booking['garage_id'] = $garage_id;

            } else {

                $booking['garage_id'] = "";

            }

            $booking['service'] = "";

            $cars = cars::select('model', 'model_year', 'mileage', 'cylinder', 'mileage')->find($booking->car_id);

            if ($cars) {

                $booking['car_details'] = $cars;

                $cars['make'] = "";



            } else {

                $booking['car_details'] = [];

                $cars['make'] = "";



            }



            $users = User::select('name', 'mobile_number', 'email', 'address')->find($booking->customer_id);



            if ($users) {

                $booking['customer_details'] = $users;

                $users['address'] = "";

                $users['brand'] = "";



            } else {

                $booking['customer_details'] = [];

            }

            $items = items::select('id', 'item')->whereIn('id', explode(",", $booking->item_id))->get();

            if ($items) {

                $booking['parts_details'] = $items;



            } else {

                $booking['parts_details'] = [];



            }





            return response()->json(['code' => 1, 'message' => 'Booking Details', 'data' => $booking]);

        } else {



            return response()->json(['code' => 0, 'message' => 'No data Found', 'data' => []]);



        }



    }



    public function AcceptBooking(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {

            $bookings->admin_status = "1";

            $bookings->delievery_charges = $request->delievery_charges;

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Admin";

            }

            $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);
                        // $token_array = explode(',', $firebaseToken[0]['device_token']);


            // $SERVER_API_KEY = 'AAAAuSeYuFY:APA91bGb58OyABfOoiE6u-AHLLNR2sXskpkD4NCXu11vAr1bXTE4FePil7A_BBRmab-hMeaMxv10W8lxIC8TKKHn9VzecXYRTqgZSLoePt0IxzLkxIArjNzIeWBXfEqG3Kp7mTj2m88Z';
            $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';
           
           if(User::select('locale')->where('email', $user->email)->where('role', '!=', null)->first()['locale']=='en'){
               
                $data = [

                "registration_ids" => $token_array,

                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Accept Booking",

                    "screen" => "screenA",

                ],
                "notification" => [

                    "title" => 'Accept Booking',

                    "body" => 'Your booking has been accepted by iMechano please pay and confirm the delievery QR ' . $bookings->delievery_charges,
                ]

            ];
           }
           else{
                $data = [

                "registration_ids" => $token_array,

                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Accept Booking",

                    "screen" => "screenA",

                ],
                "notification" => [

                    "title" => ' ',

                    "body" => '    iMechano     QR' . $bookings->delievery_charges,
                ]

            ];
               
           }
           

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . 'AAAAgjS_CVg:APA91bFY4YIvDw6x2VcyRy3_wNVmD23HRlRwtOLdbfy4-IUTfAbAJ13p8XI0w-KRDEOBdWZddecJl6m5TO2bMZV14mAcvb13p4dtROD5yp0D9r4cPj4O9y1V2Yn313YqAd1zZigZ2T5q',

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);



            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "0";

            $notifications->title = 'Accept Booking';

            $notifications->message = 'Your booking has been accepted by iMechano';

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Booking accept successfully']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }



    public function RejectBooking(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {

            $bookings->admin_status = "3";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Admin";

            }



            //   $firebaseToken = User::where('email',$user->email)->where('role','!=',null)->pluck('device_token')->all();



            $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);

            $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';

            $data = [

                "registration_ids" => $token_array,

                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Reject Booking",

                    "screen" => "screenA",

                ],

                "notification" => [

                    "title" => 'Reject Booking',

                    "body" => 'Your booking has been rejected by iMechano',

                ]

            ];

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . $SERVER_API_KEY,

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);





            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "0";

            $notifications->title = 'Reject Booking';

            $notifications->message = 'Your booking has been rejected by iMechano';

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Booking reject successfully']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }



    public function AppoiementList(Request $request)

    {

        $from_date = $request->from_date;

        $to_date = $request->to_date;



        if ($from_date && $to_date) {



            if ($from_date == $to_date) {

                $bookings = customer_bookings::select('id', 'booking_id', 'job_number', 'car_id', 'customer_id', 'time_date', 'delivery_time', 'garage_id','delivery_status', 'payment_status', 'pickup_status')->whereDate('time_date', date('Y-m-d'))

                    ->where('payment_status', '=', '1')->where('admin_status', '=', '2')->orderBy('updated_at', 'desc')->get();

            } else {

                $bookings = customer_bookings::select('id', 'booking_id', 'job_number', 'car_id', 'customer_id', 'time_date', 'delivery_time', 'garage_id', 'delivery_status','payment_status', 'pickup_status')->whereBetween('time_date', [$from_date, $to_date])

                    ->where('payment_status', '=', '1')->where('admin_status', '=', '2')->orderBy('updated_at', 'desc')->get();

            }



            foreach ($bookings as $booking) {

                $cars = cars::select('id', 'brand_id')->find($booking->car_id);
                $booking['car']=$cars;

                if ($cars) {

                    $models = car_models::select('id', 'image', 'brand_id')->where('brand_id', $cars->brand_id)->first();

                    if ($models) {

                        $booking['car_image'] = url('/storage/' . $models->image);

                    } else {

                        $booking['car_image'] = "";

                    }

                } else {

                    $booking['car_image'] = "";

                }



                $users = User::select('id', 'name')->find($booking->customer_id);

                if ($users) {

                    $booking['customer_name'] = $users->name;

                } else {

                    $booking['customer_name'] = "";

                }



                $garages = garages::select('id', 'garage_profile')->find($booking->garage_id);

                if ($garages) {

                    $booking['garage_profile'] = $garages->garage_profile;

                } else {

                    $booking['garage_profile'] = "";

                }

            }

        } else {

            $bookings = customer_bookings::select('id', 'booking_id', 'job_number', 'car_id', 'customer_id', 'time_date', 'delivery_time', 'garage_id', 'delivery_status','pickup_status', 'payment_status')

                ->where('payment_status', '=', '1')->where('admin_status', '=', '2')->orderBy('updated_at', 'desc')->get();

            foreach ($bookings as $booking) {

                $cars = cars::select('id', 'model','brand_id')->find($booking->car_id);
                                $booking['car']=$cars;


                if ($cars) {

                    $models = car_models::select('id', 'image', 'brand_id')->where('model', $cars->model)->first();

                    if ($models) {

                        $booking['car_image'] = url('/storage/' . $models->image);

                    } else {

                        $booking['car_image'] = "";

                    }

                } else {

                    $booking['car_image'] = "";

                }



                $users = User::select('id', 'name')->find($booking->customer_id);

                if ($users) {

                    $booking['customer_name'] = $users->name;

                } else {

                    $booking['customer_name'] = "";

                }



                $garages = garages::select('id', 'garage_profile')->find($booking->garage_id);

                if ($garages) {

                    $booking['garage_profile'] = $garages->garage_profile;

                } else {

                    $booking['garage_profile'] = "";

                }

            }

        }





        return response()->json(['code' => 1, 'message' => 'Appoiements List', 'data' => $bookings]);

    }



    public function NotificationList(Request $request)

    {

        $customer_id = $request->customer_id;

        $notifications = Notifications::where('customer_id', $request->customer_id)->where('admin_id', "0")->orderBy('created_at', 'desc')->get();

        return response()->json(['code' => 1, 'message' => 'Customer Notification List', 'data' => $notifications]);

    }



    public function AdminNotificationList(Request $request)

    {

        $notifications = Notifications::where('admin_id', "1")->orderBy('created_at', 'desc')->get();

        return response()->json(['code' => 1, 'message' => 'Admin Notification List', 'data' => $notifications]);

    }







    public function ChargesConfirmation(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {
            $bookings->admin_status = "2";

            $bookings->payment_status = "1";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Admin";

            }



           



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);

            $SERVER_API_KEY = 'Enter_Your_Server_Key';

            $data = [

                "registration_ids" => $token_array,
                
                  "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Payment Confirmation",

                    "screen" => "screenA",

                ],

                "notification" => [

                    "title" => 'Payment Confirmation',

                    "body" => 'payment has been done by ' . $user_name,

                ]

            ];

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);





            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Payment Confirmation';

            $notifications->message = 'payment has been done by ' . $user_name;

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Payment confirmation']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }









    public function PickupRequestByAdmin(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {

            $bookings->pickup_status = "3";

            $bookings->save();



            // Create job card

            $jobCard = new job_cards;

            $jobCard->booking_id = $request->booking_id;



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

                $jobCard->customer_name = $user->name;

                $jobCard->customer_contact_no = $user->mobile_number;

            } else {

                $user_name = "Admin";

            }



            $cars = cars::select('model', 'model_year', 'mileage', 'plate_number', 'model_year', 'chases_number', 'brand_id')->find($bookings->car_id);

            if ($cars) {

                $jobCard->car_reg_number = $cars->plate_number;

                $jobCard->year = $cars->model_year;

                $jobCard->vin_number = $cars->chases_number;

                $jobCard->mileage = $cars->mileage;

            }





            //   $model = car_models::select('id','model','brand_id')->where('brand_id',$cars->brand_id)->first();

            //   if($model){

            $jobCard->car_model = $cars->model;

            $brand = car_brands::select('id', 'brand')->where('id', $cars->brand_id)->first();

            if ($brand) {

                $jobCard->car_make = $brand->brand;

            }

            //   }

            $jobCard->save();

            $jobCard->job_number = $jobCard->id;

            $jobCard->save();



            $bookings->job_number = $jobCard->id;

            $bookings->save();



            //   $firebaseToken = User::where('email',$user->email)->where('role','!=',null)->pluck('device_token')->all();



            $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);

            $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';
           
           
           
           
           if(User::select('locale')->where('email', $user->email)->where('role', '!=', null)->first()['locale']=='en'){
                $data = [

 "registration_ids" => $token_array,

                
                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Pickup Confirmation Request",

                    "screen" => "screenA",

                ],

               "notification" => [
                    
    
                    "title" => 'Pickup Confirmation Request',

                    "body" => 'Pickup Confirmation Request by iMechano',

                ]




                

            ];
           }
           else{
                $data = [

 "registration_ids" => $token_array,

                
                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Pickup Confirmation Request",

                    "screen" => "screenA",

                ],

               "notification" => [
                    
    
                    "title" => '  ',

                    "body" => '    iMechano',

                ]




                

            ];
           }
           
        

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . $SERVER_API_KEY,

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);





            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "0";

            $notifications->title = 'Pickup Confirmation Request';

            $notifications->message = 'Pickup Confirmation Request by iMechano';

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Pickup Confirmation Request sending']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }





    public function AcceptRequest(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {



            $bookings->pickup_status = "1";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Admin";

            }



            //   $firebaseToken = User::where('email',$user->email)->where('role','!=',null)->pluck('device_token')->all();



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);

            $SERVER_API_KEY = 'Enter_Your_Server_Key';

            $data = [

                "registration_ids" => $token_array,
                "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Pickup Confirmation Accept",

                    "screen" => "screenA",

                ],

                "notification" => [

                    "title" => 'Pickup Confirmation Accept',

                    "body" => 'Pickup Confirmation Accept by ' . $user_name,

                ]

            ];

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);



            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "1";

            $notifications->title = 'Pickup Confirmation Accept';

            $notifications->message = 'Pickup Confirmation Accept by ' . $user_name;

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Pickup Confirmation Accept']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }



    public function RejectRequest(Request $request)

    {

        $bookings = customer_bookings::where('booking_id', $request->booking_id)->first();

        if ($bookings) {



            $bookings->pickup_status = "2";

            $bookings->save();



            $user = User::find($bookings->customer_id);

            if ($user) {

                $user_name = $user->name;

            } else {

                $user_name = "Admin";

            }



            //   $firebaseToken = User::where('email',$user->email)->where('role','!=',null)->pluck('device_token')->all();



            $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);

            $SERVER_API_KEY = 'Enter_Your_Server_Key';

            $data = [

                "registration_ids" => $token_array,

                "notification" => [

                    "title" => 'Pickup Confirmation Rejected',

                    "body" => 'Pickup Confirmation Rejected by ' . $user_name,

                ]

            ];

            $dataString = json_encode($data);

            $headers = [

                'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                'Content-Type: application/json',

            ];

            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

            curl_setopt($ch, CURLOPT_POST, true);

            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

            $response = curl_exec($ch);



            $notifications = new Notifications;

            $notifications->car_id = $bookings->car_id;

            $notifications->customer_id = $bookings->customer_id;

            $notifications->admin_id = "0";

            $notifications->title = 'Pickup Confirmation Rejected';

            $notifications->message = 'Pickup Confirmation Rejected by ' . $user_name;

            $notifications->save();



            return response()->json(['code' => 1, 'message' => 'Pickup Confirmation Rejected']);

        } else {

            return response()->json(['code' => 0, 'message' => 'This Booking doesnot exists']);



        }

    }







    public function AddParts(Request $request)

    {



        $parts = new customer_parts;

        $parts->job_number = $request->job_number;

        $parts->booking_id = $request->booking_id;

        $parts->part_number = $request->part_number;

        $parts->part_type = $request->part_type;

        $parts->part_desc = $request->part_desc;

        $parts->qty = $request->qty;

        $parts->est_cost = $request->est_cost;

        $parts->total = $request->total;

        $parts->report_type = $request->report_type;

        $parts->status = "0";

        $parts->save();

        return response()->json(['code' => 1, 'message' => 'Parts added successfyully', 'data' => $parts]);



    }



    public function ViewParts(Request $request)

    {

        $parts = customer_parts::where('job_number', $request->job_number)->get();



        $main_total = customer_parts::where('job_number', $request->job_number)->sum('total');



        return response()->json(['code' => 1, 'message' => 'Parts List', 'data' => $parts, 'main_total' => $main_total]);



    }


public function RejectDelivery(Request $request){
    
        $size = count(collect($request)->get('id'));
        
        
        $booking_id= DB::table('customer_items')->select('booking_id')

                ->where('id', $request->id[0])->first();
            
            
             DB::table('job_cards')

                ->where('booking_id', $booking_id->booking_id)

                ->update(['delivery_request' =>0,
                'delivery_time' => ""
                ]);
            
              DB::table('customer_bookings')

                ->where('booking_id', $booking_id->booking_id)

                ->update(['reject_status' =>1,
                            'delivery_status'=>0
                ]);
                
                
    
       
    //   $jobs=  job_cards::where('booking_id',"=",$booking_id)->first();

                

                

    for( $i=0; $i<$size;$i++){
        $affected = DB::table('customer_items')

                ->where('id', intval($request->id[$i]))

                ->update(['status' => 2]);
    }
    
    
    
                
                $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();

        // $firebaseToken =User::whereNull('role')->whereNotNull('device_token')->pluck('device_token')->all();

        $token_array = explode(',', $firebaseToken->device_token);

        $SERVER_API_KEY = 'Enter_Your_Server_Key';


            $data = [

            "registration_ids" => $token_array,

            "data" => [

                "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                "sound" => "default",
                
                // "job_number"=> $request->job_number,

                "status" => "Confirm Delivery Rejected",

                "screen" => "screenA",

            ],
            

            "notification" => [

                "title" => 'Confirm Delivery Rejected',

                "body" => 'User has rejected the delivery',

            ]

        ];

        $dataString = json_encode($data);

        $headers = [

            'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

            'Content-Type: application/json',

        ];



        $ch = curl_init();



        curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

        curl_setopt($ch, CURLOPT_POST, true);

        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);



        $response = curl_exec($ch);





        $notifications = new Notifications;

        $notifications->message = 'User has rejected the delivery';
        $notifications->admin_id="1";

        $notifications->save();
                
                
                
                
                
                
                
                            return response()->json(['code' => 1, 'message' => 'Updated Successfully',"Book"=>$booking_id->booking_id]);

        
        
    
}


    public function ViewItems(Request $request)

    {

        $job_card = DB::table('job_cards')->where('job_number', $request->job_number)->first();

        $items = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->get();

        $booking = DB::table('customer_bookings')->where('job_number', $request->job_number)->first();
        // $items['reject_status']="1";
        $request = 0; // 0 for disable button, 1 for enable button, 2 for request accepted

        $car_Image =  car_models::select('image')->where('model',"=",$job_card->car_model)->first();
        //Shoaib work here 

        $counter = 0;

        foreach ($items as $item) {

            if ($item->status == 1)

                $counter++;

        }



        if (count($items) == $counter)

            $request = intval($job_card->delivery_request);

        $status=intval($job_card->status);


        return response()->json(['code' => 1, 'message' => 'Items List', 'data' => $items, 'request' => $request, 'booking' => $booking,'status'=>$status,'carImage'=>$car_Image->image]);



    }



    public function UpdateCustomerItem(Request $request)

    {

        // return response()->json(['code'=> 1,'message'=>'Data from api.','data'=> [$request->all(),$_FILES['images'], $request->file('images')[0]->getClientOriginalName(), $request->work_done]]);

        try {

            // Get the updated rows count here. Keep in mind that zero is a

            // valid value (not failure) if there were no updates needed

            $affected = DB::table('customer_items')

                ->where('id', intval($request->id))

                ->update(['status' => 1]);









            $item = DB::table('customer_items')->where('id', intval($request->id))->first();



            $booking = DB::table('customer_bookings')->where('booking_id', intval($item->booking_id))->first();



            $user = User::find($booking->customer_id);

            if ($user) {

                $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



                $token_array = explode(',', $firebaseToken->device_token);

                $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';
                
                 if(User::select('locale')->where('email', $user->email)->where('role', '!=', null)->first()['locale']=='en'){
                     $data = [

                    "registration_ids" => $token_array,
                    
                    "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Task Completed",
                    
                    "job_number" => $booking->job_number,

                    "screen" => "screenA",

                ],

                    "notification" => [

                        "title" => $item->name . ' Task Completed',

                        "body" => $item->name . ' Task Completed by iMechano',

                    ]

                ];
                     
                 }
                 else{
                     
                     $data = [

                    "registration_ids" => $token_array,
                    
                    "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Task Completed",
                    
                    "job_number" => $booking->job_number,

                    "screen" => "screenA",

                ],

                    "notification" => [

                        "title" => $item->name . '  ',

                        "body" => $item->name . '   iMechano',

                    ]

                ];
                     
                 }
                 

                

                $dataString = json_encode($data);

                $headers = [

                    'Authorization: key=' . $SERVER_API_KEY,

                    'Content-Type: application/json',

                ];

                $ch = curl_init();

                curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

                curl_setopt($ch, CURLOPT_POST, true);

                curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

                $response = curl_exec($ch);





                $notifications = new Notifications;

                // $notifications->car_id = $bookings->car_id;

                // $notifications->customer_id = $bookings->customer_id;

                $notifications->admin_id = "0";

                $notifications->title = 'Task Completed';

                $notifications->message = 'task Completed by iMechano';

                $notifications->save();



            }





            if ($request->work_done) {

                $count = count($request->file('images'));

                $work_image = "";

                for ($i = 0; $i < $count; $i++) {

                    $fileNameExt = $request->file('images')[$i]->getClientOriginalName();

                    $fileName = pathinfo($fileNameExt, PATHINFO_FILENAME);

                    $fileExt = $request->file('images')[$i]->getClientOriginalExtension();

                    $fileNameToStore = $fileName . '_' . time() . '.' . $fileExt;

                    $pathToStore = $request->file('images')[$i]->storeAs('public', $fileNameToStore);

                    $work_image = $work_image . "" . $fileNameToStore . ",";

                }

                $affected = DB::table('customer_items')

                    ->where('id', $request->id)

                    ->update(['work_image' => $work_image, 'work_done' => $request->work_done]);

            }





            return response()->json(['code' => 1, 'message' => 'Updated Successfully']);



        } catch (\Illuminate\Database\QueryException $e) {

            // Do whatever you need if the query failed to execute

            return response()->json(['code' => 0, 'message' => 'Updated Failed ' . $e]);



        }



    }



    public function SendDeliveryRequest(Request $request)

    {

        $job_card = DB::table('job_cards')->where('job_number', $request->job_number)->first();

        $items = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->count();

        $markedItems = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->where('status', 1)->count();



        if ($job_card->delivery_request == 1) {

            return response()->json(['code' => 0, 'message' => 'Request was Sent!']);

        }

        if ($items == $markedItems) {

            $affected = DB::table('job_cards')

                ->where('job_number', $request->job_number)

                ->update(['delivery_request' => 1]);



            $booking = DB::table('customer_bookings')->where('job_number', $request->job_number)->first();



            $user = User::find($booking->customer_id);

            if ($user) {

                $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



                $token_array = explode(',', $firebaseToken->device_token);

                $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';

              if(User::select('locale')->where('email', $user->email)->where('role', '!=', null)->first()['locale']=='en'){
                  $data = [

                    "registration_ids" => $token_array,
                    
                    "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Delivery Request",

                    "screen" => "screenA",

                ],

                    "notification" => [

                        "title" => 'Delivery Request',

                        "body" => 'Delivery Request sent by iMechano',

                    ]

                ];
              }
              
              else{
                  $data = [

                    "registration_ids" => $token_array,
                    
                    "data" => [

                    "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                    "sound" => "default",

                    "status" => "Delivery Request",

                    "screen" => "screenA",

                ],

                    "notification" => [

                        "title" => ' ',

                        "body" => '      iMechano',

                    ]

                ];
              }
                

                $dataString = json_encode($data);

                $headers = [

                    'Authorization: key=' . $SERVER_API_KEY,

                    'Content-Type: application/json',

                ];

                $ch = curl_init();

                curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

                curl_setopt($ch, CURLOPT_POST, true);

                curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

                $response = curl_exec($ch);





                $notifications = new Notifications;

                // $notifications->car_id = $bookings->car_id;

                // $notifications->customer_id = $bookings->customer_id;

                $notifications->admin_id = "0";

                $notifications->title = 'Delivery Request';

                $notifications->message = 'Delivery Request sent by iMechano';

                $notifications->save();



            }



            return response()->json(['code' => 1, 'message' => 'Delivery Request sent']);

        } else {

            return response()->json(['code' => 0, 'message' => 'Please Mark All Tasks']);

        }



    }



    public function AcceptDeliveryRequest(Request $request)

    {

        $job_card = DB::table('job_cards')->where('job_number', $request->job_number)->first();

        $items = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->count();

        $markedItems = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->where('status', 1)->count();



        if ($job_card->delivery_request == 2) {

            return response()->json(['code' => 0, 'message' => 'Request was Accepted!']);

        }

        if ($items == $markedItems) {

            $affected = DB::table('job_cards')

                ->where('job_number', $request->job_number)

                ->update(['delivery_request' => 2, 'delivery_time' => $request->time_date]);



                $affected = DB::table('customer_bookings')

                ->where('job_number', $request->job_number)

                ->update(['delivery_time' => $request->time_date, 'pickup_status' => 2]);



            $booking = DB::table('customer_bookings')->where('job_number', $request->job_number)->first();

            



            $user = User::find($booking->customer_id);

            if ($user) {

                $firebaseToken = User::select('device_token')->where('email', 'admin@gmail.com')->where('role', '=', null)->first();



            $token_array = explode(',', $firebaseToken->device_token);

                $SERVER_API_KEY = 'Enter_Your_Server_Key';

                $data = [

                    "registration_ids" => $token_array,

                    "data" => [

                        "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                        "sound" => "default",

                        "status" => "Delivery Scheduled",

                        "screen" => "screenA",

                    ],

                    "notification" => [

                        "title" => 'Delivery Scheduled at '.$request->time_date,

                        "body" => 'Delivery Scheduled by '.$user->name,

                    ]

                ];

                $dataString = json_encode($data);

                $headers = [

                    'Authorization: key=' . 'AAAA-9hVRqE:APA91bHalFcbuWdKaNBQ7MI6_kQCRCGazWRGz8k-a9TzrLM_kWbKxz2NPcwGOV1FsI6a8qCIPlZbn-C9mMXDykux5EzmUIt3dX0IhbuGsEISk3EYp-J9ynveBP6Om1eXeSl8wkX6OpTo',

                    'Content-Type: application/json',

                ];

                $ch = curl_init();

                curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

                curl_setopt($ch, CURLOPT_POST, true);

                curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

                $response = curl_exec($ch);





                $notifications = new Notifications;

                // $notifications->car_id = $bookings->car_id;

                // $notifications->customer_id = $bookings->customer_id;

                $notifications->admin_id = "1";

                $notifications->title = 'Delivery Scheduled';

                $notifications->message = 'Delivery Scheduled by '.$user->name.' at '.$request->time_date;

                $notifications->save();



            }



            return response()->json(['code' => 1, 'message' => 'Delivery Request accepted']);

        } else {

            return response()->json(['code' => 0, 'message' => 'Please Mark All Tasks']);

        }



    }



    public function SetJobCardCompleted(Request $request)

    {

        $job_card = DB::table('job_cards')->where('job_number', $request->job_number)->first();

        $items = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->count();

        $markedItems = DB::table('customer_items')->where('booking_id', $job_card->booking_id)->where('status', 1)->count();



        if ($job_card->status == "1") {

            return response()->json(['code' => 0, 'message' => 'This Job Card was Completed!']);

        }

        if ($items == $markedItems) {

            $affected = DB::table('job_cards')

                ->where('job_number', $request->job_number)

                ->update(['status' => "1"]);



            $booking = DB::table('customer_bookings')->where('job_number', $request->job_number)->first();



            $user = User::find($booking->customer_id);

            if ($user) {

                $firebaseToken = User::select('device_token')->where('email', $user->email)->where('role', '!=', null)->first();



                $token_array = explode(',', $firebaseToken->device_token);

                $SERVER_API_KEY = 'AAAAgjS_CVg:APA91bHSUmAl5yUmOZXOJ_BOj1CjArBknrlRMjvUgd8_isesO5zMC9FwPwlOgKU7i4WfkxAozmj5Yse-TIzqDIUpQQ-jRRdg4bpO7v43bP8tnJiRhJDTslBRHAIVSCImb_VuKBXnt-ea';

                $data = [

                    "registration_ids" => $token_array,

                    "data" => [

                        "click_action" => "FLUTTER_NOTIFICATION_CLICK",

                        "sound" => "default",

                        "status" => "Job Card",

                        "screen" => "screenA",

                    ],

                    "notification" => [

                        "title" => 'Job Card Completed',

                        "body" => 'Job Card Completed by iMechano',

                    ]

                ];

                $dataString = json_encode($data);

                $headers = [

                    'Authorization: key=' . $SERVER_API_KEY,

                    'Content-Type: application/json',

                ];

                $ch = curl_init();

                curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/fcm/send');

                curl_setopt($ch, CURLOPT_POST, true);

                curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);

                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $dataString);

                $response = curl_exec($ch);





                $notifications = new Notifications;

                // $notifications->car_id = $bookings->car_id;

                // $notifications->customer_id = $bookings->customer_id;

                $notifications->admin_id = "0";

                $notifications->title = 'Job Card Completed';

                $notifications->message = 'Job Card Completed by iMechano';

                $notifications->save();



            }



            return response()->json(['code' => 1, 'message' => 'Job Card Completed']);

        } else {

            return response()->json(['code' => 0, 'message' => 'Please Mark All Tasks']);

        }



    }

    public function DeleteParts(Request $request)

    {

        $parts = customer_parts::find($request->id);

        if ($parts) {

            $parts->delete();

            return response()->json(['code' => 1, 'message' => 'delete Parts']);



        } else {

            return response()->json(['code' => 0, 'message' => 'No Data Found']);



        }



    }



    public function AddService(Request $request)

    {



        $service = new customer_services;

        $service->job_number = $request->job_number;

        $service->booking_id = $request->booking_id;

        $service->service_number = $request->service_number;

        $service->service_type = $request->service_type;

        $service->service_desc = $request->service_desc;

        $service->qty = $request->qty;

        $service->service_cost = $request->service_cost;

        $service->total = $request->total;

        $service->report_type = $request->report_type;

        $service->status = "0";

        $service->save();

        return response()->json(['code' => 1, 'message' => 'service added successfyully', 'data' => $service]);



    }





    public function ViewService(Request $request)

    {

        $service = customer_services::where('job_number', $request->job_number)->get();

        $main_total = customer_services::where('job_number', $request->job_number)->sum('total');



        return response()->json(['code' => 1, 'message' => 'service List', 'data' => $service, 'main_total' => $main_total]);



    }

public function ChangeLocale(Request $request){
    
    
      User::where('id', $request->id)

            ->update([

                'locale'=>$request->locale

            ]);
            
    
       
    
    
    return response()->json(['code' => $request->locale, 'message' => 'Locale Changed Successfully']);
    
}




    public function DeleteService(Request $request)

    {

        $service = customer_services::find($request->id);

        if ($service) {

            $service->delete();

            return response()->json(['code' => 1, 'message' => 'service deleted']);



        } else {

            return response()->json(['code' => 0, 'message' => 'No Data Found']);



        }



    }

}